

<!DOCTYPE html>
<html lang="zh-CN" xmlns:v-bind="http://www.w3.org/1999/xhtml">

<head>
    <title>入门 ANTLR 4 - Zong</title>
<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Zong">
<meta name="description" content="



最近因为业务需要，所以开始接触 ANTLR 4 语法解析器，在业务层面需要适配自己业务特征的 DSL 输入...">
<meta name="keywords" content="Blog JavaScript TypeScript Front-end CSS">

    <meta charset="utf-8">
    <meta name="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta name="renderer" content="webkit">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/journal.css?48520811">

<link rel="icon" href="/images/favicon.ico">

<script src="/js/loadCSS.js"></script>
<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Material+Icons");
    (function(d) {
        var config = {
        kitId: 'ojl5tfq',
        scriptTimeout: 3000,
        async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
    })(document);
</script>
<noscript>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Anonymous+Pro:400|Material+Icons"/>
</noscript>
<meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="Zong" type="application/atom+xml">
</head>
<body>
<div id="top"></div>
<div id="app">
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            <a class="a-block drawer-menu-item false" href="https://zongzi531.github.io">
                首页
            </a>
            

            
            
                
                    <a class="a-block drawer-menu-item false" href="/archives/index.html">
                        回顾
                    </a>
                
            
                
                    <a class="a-block drawer-menu-item false" href="/syoukai/index.html">
                        紹介
                    </a>
                
            
                
            
                
                    <a class="a-block drawer-menu-item false" href="/bangumi/index.html">
                        番組
                    </a>
                
            

            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="/">
            Zong
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="/">
        <div class="single-column-header-title">Zong</div>
        <div class="single-column-header-subtitle"></div>
    </a>
</div>
<div ref="sideContainer" class="side-container">
    <a class="a-block nav-head false" href="/">
        <div class="nav-title">
            Zong
        </div>
        <div class="nav-subtitle">
            人之所以能<br>，是相信能
        </div>
    </a>

    <div class="nav-link-list">
        

        
        
            
                <a class="a-block nav-link-item false" href="/archives/index.html">
                    回顾
                </a>
            
        
            
                <a class="a-block nav-link-item false" href="/syoukai/index.html">
                    紹介
                </a>
            
        
            
        
            
                <a class="a-block nav-link-item false" href="/bangumi/index.html">
                    番組
                </a>
            
        

        
    </div>

    <div class="nav-footer">
        &copy; 2017 - 2025 <a href="https://zongzi531.github.io">Zong</a>
    </div>
</div>
<div ref="extraContainer" class="extra-container">
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>

        
    </div>
</div>



<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            <div class="post-head-wrapper"
                 style="background-image: url('/2025/02/11/入门antlr4/antlr-logo.png')">
                <div class="post-title">
                    入门 ANTLR 4
                    <div class="post-meta">
                        <time datetime="2025-02-11T15:52:29.000Z" itemprop="datePublished">
                            2025-02-11 15:52
                        </time>&nbsp;
                        
                        
                        <i class="material-icons" style="">folder</i>
                        
                        <a href='/categories/Tools/'>Tools</a>
                        
                        
    
                        
                        
                        <i class="material-icons" style="">label</i>
                        
                        <a href='/tags/ANTLR/'>ANTLR</a>, 
                        
                        <a href='/tags/ANTLR-4/'>ANTLR 4</a>, 
                        
                        <a href='/tags/语法解析器/'>语法解析器</a>
                        
                        
                    </div>
                </div>
            </div>
    
            <div class="post-body-wrapper">
                <div class="post-body">
                    <!-- no node -->

<span id="more"></span>

<p>最近因为业务需要，所以开始接触 ANTLR 4 语法解析器，在业务层面需要适配自己业务特征的 DSL 输入框。</p>
<p>调研了几种方向：</p>
<table>
<thead>
<tr>
<th>方案</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>纯纯的 <code>string</code> 解析</td>
<td>开发周期短，轻松</td>
<td>迭代成本高，容易推翻重做</td>
</tr>
<tr>
<td>Babel 解析</td>
<td>基于文本解析成 AST 语法树，通过 AST 来完成业务，迭代轻松</td>
<td>需要实现文本分词，浏览器环境使用为动态解析，存在性能损耗</td>
</tr>
<tr>
<td>ANTLR 4 解析</td>
<td>定义语法能够静态编译出对应代码，迭代轻松</td>
<td>需要学习 ANTLR 4 生态环境</td>
</tr>
</tbody></table>
<blockquote>
<p>结合业务场景的需要，考虑到未来的迭代可能，所以决定使用 ANTLR 4 解析方案。</p>
</blockquote>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p><code>package.json</code> 所需依赖：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>版本</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>antlr4ng-cli</code></td>
<td><code>^1.0.7</code></td>
<td>将 ANTLR 4 编译为 TypeScript 文件的终端执行文件</td>
</tr>
<tr>
<td><code>antlr-format-cli</code></td>
<td><code>^1.2.1</code></td>
<td>美化 <code>*.g4</code> 格式</td>
</tr>
<tr>
<td><code>antlr4ng</code></td>
<td><code>2.0.11</code></td>
<td>ANTLR 4 在 JavaScript 运行时</td>
</tr>
<tr>
<td><code>antlr4-c3</code></td>
<td><code>3.3.7</code></td>
<td>ANTLR 4 代码补全包</td>
</tr>
</tbody></table>
<blockquote>
<p>使用 <code>antlr4ng-cli</code> 编译需要电脑安装 JDK ，我这里对应的 JDK 版本是 17.0.12。<br>编译脚本参考<a target="_blank" rel="noopener" href="https://github.com/DTStack/dt-sql-parser/blob/main/scripts/antlr4.js">DTStack&#x2F;dt-sql-parser</a>。<br>仓库使用 <code>inquirer</code> 包进行多 DSL 编译，因为业务场景，我移除了此功能，只对指定的文件进行编译工作。</p>
</blockquote>
<h1 id="解析器"><a href="#解析器" class="headerlink" title="解析器"></a>解析器</h1><p>简单做个示例，实现变量比较的功能。</p>
<p>在对应的目录下创建 <code>XXLLexer.g4</code> 词法分析文件和 <code>XXLParser.g4</code> 解析文件。</p>
<pre class="line-numbers language-antlr" data-language="antlr"><code class="language-antlr">&#x2F;&#x2F; XXLLexer.g4
&#x2F;&#x2F; ...
lexer grammar XXLLexer;

options &#123;
    caseInsensitive&#x3D; true;
&#125;

EQUAL                  : &#39;&#x3D;&#x3D;&#39;;
AND                    : &#39;AND&#39;;
OR                     : &#39;OR&#39;;

VALUE                  : (LETTER | DIGIT)+;

SPACE                  : [ \t\r\n]+ -&gt; skip;

fragment DIGIT         : [0-9];
fragment LETTER        : [A-Za-z];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-antlr" data-language="antlr"><code class="language-antlr">&#x2F;&#x2F; XXLParser.g4
&#x2F;&#x2F; ...
parser grammar XXLParser;

options &#123;
    tokenVocab&#x3D; XXLLexer;
    caseInsensitive&#x3D; true;
    superClass&#x3D;ParserBase;
&#125;

@header &#123;
import &#123; ParserBase &#125; from &#39;..&#x2F;ParserBase&#39;;
&#125;

program
    : singleStatement (AND | OR)* singleStatement* EOF
    ;

singleStatement
    : singleStatement (AND | OR) singleStatement
    | equalStatement
    ;

equalStatement
    : VALUE EQUAL VALUE
    ;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后支持的效果是：</p>
<ul>
<li><code>a == b</code></li>
<li><code>C1 == Z AND a == b</code></li>
</ul>
<p>解析器的类也基于业务做了调整，可以参考 dt-sql-parser 项目。<br>g4 语法学习请参考<a target="_blank" rel="noopener" href="https://github.com/antlr/antlr4/blob/dev/doc/getting-started.md">Getting Started with ANTLR v4</a>。<br>语法参考<a target="_blank" rel="noopener" href="https://github.com/antlr/grammars-v4">antlr&#x2F;grammars-v4</a>。</p>
<h1 id="代码补全"><a href="#代码补全" class="headerlink" title="代码补全"></a>代码补全</h1><p>可以自己基于解析器实现一个代码补全方法，创建的方法：</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> CandidatesCollection<span class="token punctuation">,</span> CodeCompletionCore <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'antlr4-c3'</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">const</span> core <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodeCompletionCore</span><span class="token punctuation">(</span>parserIns<span class="token comment">/* 解析器实例 */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 设置需要匹配的规则
 * 比如：singleStatement
 * 则设置：
 * protected preferredRules = new Set([
 *   XXLParser.RULE_singleStatement,
 * ]);
 */</span>
core<span class="token punctuation">.</span>preferredRules <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>preferredRules<span class="token punctuation">;</span>

<span class="token comment">// 获得候选列表</span>
<span class="token keyword">const</span> candidates <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">collectCandidates</span><span class="token punctuation">(</span>caretTokenIndex<span class="token punctuation">,</span> c3Context<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>基于候选列表，可以提供一个体检舒适的 DSL 文本输入框，具备代码补全功能。</p>
<p>到此，算是浅尝了一下 ANTLR 4 ，能感受到的好处就是，当 DSL 产生迭代后，我基本只需要修改 g4 文件，重新编译即可。</p>
<p>非常的舒适～</p>

                </div>
            </div>

            
            <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者: </strong>
    Zong
  </li>
  <li class="post-copyright-link">
    <strong>本文链接: </strong>
    <a href="https://zongzi531.github.io/2025/02/11/%E5%85%A5%E9%97%A8antlr4/" title="入门 ANTLR 4">https://zongzi531.github.io/2025/02/11/%E5%85%A5%E9%97%A8antlr4/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明: </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

            
    
            <nav class="post-pagination">
    
    <a class="newer-posts" href="/2025/03/03/%E8%B5%8F%E8%8A%B12/">
        上一篇<br>赏花Ⅱ
    </a>
    
    <span class="page-number"></span>
    
    <a class="older-posts" href="/2025/02/06/%E8%9B%87%E8%9B%87%E5%A6%82%E6%84%8F/">
        下一篇<br>蛇蛇如意
    </a>
    
</nav>

    
            

<div class="post-comment-wrapper">
    <div class="giscus"></div>
</div>


        </div>
    </div>
    <div class="single-column-footer">
    &copy; 2017 - 2025 <a href="https://zongzi531.github.io">Zong</a>
</div>
</div>

</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"
        integrity="sha256-EGs9T1xMHdvM1geM8jPpoo8EZ1V1VRsmcJz8OByENLA=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"
        integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"
        integrity="sha256-FtWfRI+thWlNz2sB3SJbwKx5PgMyKIVgwHCTwa3biXc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@14.2.1/dist/smooth-scroll.polyfills.min.js"
        integrity="sha256-CI4Gq5E0io1Pv0xM3qPM+NUIOhbIBvC3GiN1Y4KhXpw=" crossorigin="anonymous"></script>
<script src="/js/journal.js?39873406"></script>


    <script src="https://giscus.app/client.js"
    data-repo="zongzi531/zongzi531.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkyMTgyODY2MjA="
    data-category="General"
    data-category-id="DIC_kwDODQLKHM4COlHH"
    data-mapping="url"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
</script>


</body>
</html>
