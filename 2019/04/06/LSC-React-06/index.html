

<!DOCTYPE html>
<html lang="zh-CN" xmlns:v-bind="http://www.w3.org/1999/xhtml">

<head>
    <title>React 源码学习（六）：组件渲染 - Zong</title>
<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Zong">
<meta name="description" content="




阅读源码成了今年的学习目标之一，在选择 Vue 和 React 之间，我想先阅读 React 。在考虑到...">
<meta name="keywords" content="Blog JavaScript TypeScript Front-end CSS">

    <meta charset="utf-8">
    <meta name="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta name="renderer" content="webkit">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/journal.css?27886434">

<link rel="icon" href="/images/favicon.ico">

<script src="/js/loadCSS.js"></script>
<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Material+Icons");
    (function(d) {
        var config = {
        kitId: 'ojl5tfq',
        scriptTimeout: 3000,
        async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
    })(document);
</script>
<noscript>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Anonymous+Pro:400|Material+Icons"/>
</noscript>
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="Zong" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-material-oceanic.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
<body>
<div id="top"></div>
<div id="app">
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            <a class="a-block drawer-menu-item false" href="https://zongzi531.com">
                首页
            </a>
            

            
            
                
                    <a class="a-block drawer-menu-item false" href="/commuting/index.html">
                        通勤那点事
                    </a>
                
            
                
            
                
            
                
            
                
                    <a class="a-block drawer-menu-item false" href="/bangumi/index.html">
                        番組
                    </a>
                
            
                
                    <a class="a-block drawer-menu-item false" href="/nihongonokona/index.html">
                        日本語のコーナー
                    </a>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
                    <a class="a-block drawer-menu-item false" href="/syoukai/index.html">
                        紹介
                    </a>
                
            
                
            

            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="/">
            Zong
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="/">
        <div class="single-column-header-title">Zong</div>
        <div class="single-column-header-subtitle"></div>
    </a>
</div>
<div ref="sideContainer" class="side-container">
    <a class="a-block nav-head false" href="/">
        <div class="nav-title">
            Zong
        </div>
        <div class="nav-subtitle">
            人之所以能<br>，是相信能
        </div>
    </a>

    <div class="nav-link-list">
        

        
        
            
                <a class="a-block nav-link-item false" href="/commuting/index.html">
                    通勤那点事
                </a>
            
        
            
        
            
        
            
        
            
                <a class="a-block nav-link-item false" href="/bangumi/index.html">
                    番組
                </a>
            
        
            
                <a class="a-block nav-link-item false" href="/nihongonokona/index.html">
                    日本語のコーナー
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
                <a class="a-block nav-link-item false" href="/syoukai/index.html">
                    紹介
                </a>
            
        
            
        

        
    </div>

    <div class="nav-footer">
        <div style="margin-bottom: 8px;">
            <a title="GitHub" target="_blank" rel="noopener" href="https://github.com/zongzi531" style="margin: 0px 2px;"><svg height="16" width="16" viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a>
            <a title="知乎" target="_blank" rel="noopener" href="https://www.zhihu.com/people/zongzi531/posts" style="margin: 0px 2px;"><img height="16" src="https://static.zhihu.com/static/favicon.ico"></a>
            <a title="掘金" target="_blank" rel="noopener" href="https://juejin.im/user/58747cf2ac502e00646e3b8b/posts" style="margin: 0px 2px;"><img height="16" src="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/favicons/favicon-32x32.png"></a>
            <a title="力扣" target="_blank" rel="noopener" href="https://leetcode-cn.com/u/zongzi0531/" style="margin: 0px 2px;"><img height="16" src="https://static.leetcode-cn.com/cn-assets/icons/favicon-32x32.png"></a>
        </div>
        &copy; 2017 - 2023 <a href="https://zongzi531.com">Zong</a>
    </div>
</div>
<div ref="extraContainer" class="extra-container">
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>

        
    </div>
</div>



<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            <div class="post-head-wrapper-text-only"
                 style="background-image: url('')">
                <div class="post-title">
                    React 源码学习（六）：组件渲染
                    <div class="post-meta">
                        <time datetime="2019-04-06T09:52:00.000Z" itemprop="datePublished">
                            2019-04-06 09:52
                        </time>&nbsp;
                        
                        
                        <i class="material-icons" style="">folder</i>
                        
                        <a href='/categories/React-源码学习/'>React 源码学习</a>
                        
                        
    
                        
                        
                        <i class="material-icons" style="">label</i>
                        
                        <a href='/tags/React/'>React</a>
                        
                        
                    </div>
                </div>
            </div>
    
            <div class="post-body-wrapper">
                <div class="post-body">
                    <!-- no node -->

<span id="more"></span>

<blockquote>
<p>阅读源码成了今年的学习目标之一，在选择 Vue 和 React 之间，我想先阅读 React 。<br>在考虑到读哪个版本的时候，我想先接触到源码早期的思想可能会更轻松一些，最终我选择阅读 <code>0.3-stable</code> 。<br>那么接下来，我将从几个方面来解读这个版本的源码。</p>
</blockquote>
<ol>
<li><a href="https://zongzi531.com/2019/04/01/LSC-React-01/">React 源码学习（一）：HTML 元素渲染</a></li>
<li><a href="https://zongzi531.com/2019/04/02/LSC-React-02/">React 源码学习（二）：HTML 子元素渲染</a></li>
<li><a href="https://zongzi531.com/2019/04/03/LSC-React-03/">React 源码学习（三）：CSS 样式及 DOM 属性</a></li>
<li><a href="https://zongzi531.com/2019/04/04/LSC-React-04/">React 源码学习（四）：事务机制</a></li>
<li><a href="https://zongzi531.com/2019/04/05/LSC-React-05/">React 源码学习（五）：事件机制</a></li>
<li><a href="https://zongzi531.com/2019/04/06/LSC-React-06/">React 源码学习（六）：组件渲染</a></li>
<li><a href="https://zongzi531.com/2019/04/07/LSC-React-07/">React 源码学习（七）：生命周期</a></li>
<li><a href="https://zongzi531.com/2019/04/08/LSC-React-08/">React 源码学习（八）：组件更新</a></li>
<li><a href="https://zongzi531.com/2019/12/18/LSC-React-09/">React 源码学习（九）：“脱胎换骨”</a></li>
<li><a href="https://zongzi531.com/2019/12/19/LSC-React-10/">React 源码学习（十）：Fiber</a></li>
<li><a href="https://zongzi531.com/2019/12/20/LSC-React-11/">React 源码学习（十一）：Scheduling</a></li>
<li><a href="https://zongzi531.com/2019/12/21/LSC-React-12/">React 源码学习（十二）：Reconciliation</a></li>
</ol>
<h2 id="React-组件渲染-React-createClass"><a href="#React-组件渲染-React-createClass" class="headerlink" title="React 组件渲染 React.createClass"></a>React 组件渲染 React.createClass</h2><p>终于要说到组件渲染了，其实组件渲染就是基于 HTML 元素渲染，我们在重新回到熟悉的例子，这是一个完整的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// #examples</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ExampleApplication</span> = <span class="title class_">React</span>.<span class="title function_">createClass</span>(&#123;</span><br><span class="line">  <span class="attr">render</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> elapsed = <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">elapsed</span>  / <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">var</span> seconds = elapsed / <span class="number">10</span> + (elapsed % <span class="number">10</span> ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27;.0&#x27;</span> );</span><br><span class="line">    <span class="keyword">var</span> message =</span><br><span class="line">      <span class="string">&#x27;React has been successfully running for &#x27;</span> + seconds + <span class="string">&#x27; seconds.&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">React</span>.<span class="property">DOM</span>.<span class="title function_">p</span>(<span class="literal">null</span>, message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> start = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line"></span><br><span class="line"><span class="title class_">React</span>.<span class="title function_">renderComponent</span>(</span><br><span class="line">  <span class="title class_">ExampleApplication</span>(&#123;<span class="attr">elapsed</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() - start&#125;),</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;container&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>使用 <code>type=&quot;text/jsx&quot;</code> 的形式编写：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@jsx</span> React.DOM */</span></span><br><span class="line"><span class="comment">// #examples</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ExampleApplication</span> = <span class="title class_">React</span>.<span class="title function_">createClass</span>(&#123;</span><br><span class="line">  <span class="attr">render</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> elapsed = <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">elapsed</span>  / <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">var</span> seconds = elapsed / <span class="number">10</span> + (elapsed % <span class="number">10</span> ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27;.0&#x27;</span> );</span><br><span class="line">    <span class="keyword">var</span> message =</span><br><span class="line">      <span class="string">&#x27;React has been successfully running for &#x27;</span> + seconds + <span class="string">&#x27; seconds.&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;message&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> start = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line"></span><br><span class="line"><span class="title class_">React</span>.<span class="title function_">renderComponent</span>(</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">ExampleApplication</span> <span class="attr">elapsed</span>=<span class="string">&#123;new</span> <span class="attr">Date</span>()<span class="attr">.getTime</span>() <span class="attr">-</span> <span class="attr">start</span>&#125; /&gt;</span></span>,</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;container&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="复合组件"><a href="#复合组件" class="headerlink" title="复合组件"></a>复合组件</h3><p>在这里，我们看到创建组件的方法是 <code>React.createClass</code> ，组件就是一堆 HTML 元素的集合，但是组件具有状态 (<code>state</code>) 和属性 (<code>props</code>) ，还具有生命周期，并且组件可以更新。所以我们会一一将其到来，那么本次我们仅讨论组件渲染。我们看到复合组件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactCompositeComponent.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactCompositeComponent</span> = &#123;</span><br><span class="line">  <span class="attr">createClass</span>: <span class="keyword">function</span>(<span class="params">spec</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Constructor</span> = <span class="keyword">function</span>(<span class="params">initialProps, children</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">construct</span>(initialProps, children);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Constructor</span>.<span class="property"><span class="keyword">prototype</span></span> = <span class="keyword">new</span> <span class="title class_">ReactCompositeComponentBase</span>();</span><br><span class="line">    <span class="title class_">Constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">constructor</span> = <span class="title class_">Constructor</span>;</span><br><span class="line">    <span class="title function_">mixSpecIntoComponent</span>(<span class="title class_">Constructor</span>, spec);</span><br><span class="line">    <span class="title function_">invariant</span>(</span><br><span class="line">      <span class="title class_">Constructor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">render</span>,</span><br><span class="line">      <span class="string">&#x27;createClass(...): Class specification must implement a `render` method.&#x27;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">ConvenienceConstructor</span> = <span class="keyword">function</span>(<span class="params">props, children</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Constructor</span>(props, children);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">ConvenienceConstructor</span>.<span class="property">componentConstructor</span> = <span class="title class_">Constructor</span>;</span><br><span class="line">    <span class="title class_">ConvenienceConstructor</span>.<span class="property">originalSpec</span> = spec;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">ConvenienceConstructor</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>看到 <code>React.createClass</code> 是不是发现和 <code>ReactDOM.js</code> 下的 <code>createDOMComponentClass</code> 函数很相似。确实如此，在你看懂了 HTML 元素渲染的实现后来看这个确实会容易很多，那么接受参数 <code>spec</code> 是什么呢？是 <code>specification</code> 规范，按照官方注释翻译为：在给定类规范的情况下创建复合组件类。我们从上面代码也可以看出 <code>render</code> 方法是必不可少的。他的原型映射到 <code>ReactCompositeComponentBase</code> ，那么让我们来看看他。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactCompositeComponent.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactCompositeComponentBase</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;;</span><br><span class="line"><span class="title function_">mixInto</span>(<span class="title class_">ReactCompositeComponentBase</span>, <span class="title class_">ReactComponent</span>.<span class="property">Mixin</span>);</span><br><span class="line"><span class="title function_">mixInto</span>(<span class="title class_">ReactCompositeComponentBase</span>, <span class="title class_">ReactOwner</span>.<span class="property">Mixin</span>);</span><br><span class="line"><span class="title function_">mixInto</span>(<span class="title class_">ReactCompositeComponentBase</span>, <span class="title class_">ReactPropTransferer</span>.<span class="property">Mixin</span>);</span><br><span class="line"><span class="title function_">mixInto</span>(<span class="title class_">ReactCompositeComponentBase</span>, <span class="title class_">ReactCompositeComponentMixin</span>);</span><br></pre></td></tr></table></figure>

<h3 id="渲染至-DOM-节点方法-mountComponent"><a href="#渲染至-DOM-节点方法-mountComponent" class="headerlink" title="渲染至 DOM 节点方法 mountComponent"></a>渲染至 DOM 节点方法 mountComponent</h3><p>熟悉吧， React 这种写法，原型链上的属性疯狂合并，并且原型链上的属性互相被连续调用。当然在方法中也有这样一行代码 <code>mixSpecIntoComponent(Constructor, spec);</code> ，他在 <code>mixInto</code> 的基础上做了更多的处理，但是他与 <code>mixInto</code> 的功能效果是一样的。那么接下来，先让我们看到当执行 <code>React.renderComponent</code> 方法后，复合组件会做出什么样的反应。我们看到代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactCompositeComponent.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactCompositeComponentMixin</span> = &#123;</span><br><span class="line">  <span class="attr">construct</span>: <span class="keyword">function</span>(<span class="params">initialProps, children</span>) &#123;</span><br><span class="line">    <span class="title class_">ReactComponent</span>.<span class="property">Mixin</span>.<span class="property">construct</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, initialProps, children);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_pendingState</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_compositeLifeCycleState</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mountComponent</span>: <span class="keyword">function</span>(<span class="params">rootID, transaction</span>) &#123;</span><br><span class="line">    <span class="comment">// 这里与 ReactNativeComponent.Mixin.mountComponent 一致</span></span><br><span class="line">    <span class="comment">// 都执行了此方法，剩下的区别只是针对 HTML 组件和复合组件的区别</span></span><br><span class="line">    <span class="comment">// HTML 组件只需产出 markup 标记，添加 CSS 样式， DOM 属性，事件监听</span></span><br><span class="line">    <span class="comment">// 复合组件却不一样，上面已经提到过。</span></span><br><span class="line">    <span class="title class_">ReactComponent</span>.<span class="property">Mixin</span>.<span class="property">mountComponent</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, rootID, transaction);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 组件的生命周期和复合组件的生命周期</span></span><br><span class="line">    <span class="comment">// Unset `this._lifeCycleState` until after this method is finished.</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_lifeCycleState</span> = <span class="title class_">ReactComponent</span>.<span class="property">LifeCycle</span>.<span class="property">UNMOUNTED</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_compositeLifeCycleState</span> = <span class="title class_">CompositeLifeCycle</span>.<span class="property">MOUNTING</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">constructor</span>.<span class="property">propDeclarations</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_assertValidProps</span>(<span class="variable language_">this</span>.<span class="property">props</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定 this 执行上下文有关，与 mixSpecIntoComponent 有关联</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">__reactAutoBindMap</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_bindAutoBindMethods</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 组件状态相关</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable language_">this</span>.<span class="property">getInitialState</span> ? <span class="variable language_">this</span>.<span class="title function_">getInitialState</span>() : <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_pendingState</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生命周期相关</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">componentWillMount</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">componentWillMount</span>();</span><br><span class="line">      <span class="comment">// When mounting, calls to `setState` by `componentWillMount` will set</span></span><br><span class="line">      <span class="comment">// `this._pendingState` without triggering a re-render.</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_pendingState</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable language_">this</span>.<span class="property">_pendingState</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_pendingState</span> = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生命周期相关</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">componentDidMount</span>) &#123;</span><br><span class="line">      <span class="comment">// 这里需要特别提一下，你可以看到，这是 React 调度事务，并且 ReactOnDOMReady 在调度事务 close 时</span></span><br><span class="line">      <span class="comment">// 会执行队列中的事务，所以你可以理解组件被挂载后这个生命周期是如何实现的。</span></span><br><span class="line">      transaction.<span class="title function_">getReactOnDOMReady</span>().<span class="title function_">enqueue</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">componentDidMount</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 _renderValidatedComponent 方法</span></span><br><span class="line">    <span class="comment">// 返回 ReactNativeComponent</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_renderedComponent</span> = <span class="variable language_">this</span>.<span class="title function_">_renderValidatedComponent</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生命周期相关</span></span><br><span class="line">    <span class="comment">// Done with mounting, `setState` will now trigger UI changes.</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_compositeLifeCycleState</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_lifeCycleState</span> = <span class="title class_">ReactComponent</span>.<span class="property">LifeCycle</span>.<span class="property">MOUNTED</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 ReactNativeComponent.mountComponent 生成 markup 标记</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_renderedComponent</span>.<span class="title function_">mountComponent</span>(rootID, transaction);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">_renderValidatedComponent</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 这一步使用来控制正确的 Owner</span></span><br><span class="line">    <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span> = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 调用 render 方法的返回</span></span><br><span class="line">    <span class="keyword">var</span> renderedComponent = <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line">    <span class="comment">// 这一步使用来控制正确的 Owner</span></span><br><span class="line">    <span class="comment">// 在 ReactNativeComponent 实例化时 ReactCurrentOwner.current 会被记录</span></span><br><span class="line">    <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="title function_">invariant</span>(</span><br><span class="line">      <span class="title class_">ReactComponent</span>.<span class="title function_">isValidComponent</span>(renderedComponent),</span><br><span class="line">      <span class="string">&#x27;%s.render(): A valid ReactComponent must be returned.&#x27;</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">constructor</span>.<span class="property">displayName</span> || <span class="string">&#x27;ReactCompositeComponent&#x27;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> renderedComponent;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>那么组件渲染讲的也差不多了，我们对其他一些，也先在这边提起来。回到这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactCompositeComponent.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactCompositeComponentBase</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;;</span><br><span class="line"><span class="comment">// 一些 DOM 操作， React 调度事务相关，并包括生命周期</span></span><br><span class="line"><span class="comment">// ReactNativeComponent 也同样含有</span></span><br><span class="line"><span class="title function_">mixInto</span>(<span class="title class_">ReactCompositeComponentBase</span>, <span class="title class_">ReactComponent</span>.<span class="property">Mixin</span>);</span><br><span class="line"><span class="comment">// 用于操作 ref ，相关代码随行在 ReactComponent 中，这里也不做详细解读</span></span><br><span class="line"><span class="title function_">mixInto</span>(<span class="title class_">ReactCompositeComponentBase</span>, <span class="title class_">ReactOwner</span>.<span class="property">Mixin</span>);</span><br><span class="line"><span class="comment">// props 传输功能</span></span><br><span class="line"><span class="title function_">mixInto</span>(<span class="title class_">ReactCompositeComponentBase</span>, <span class="title class_">ReactPropTransferer</span>.<span class="property">Mixin</span>);</span><br><span class="line"><span class="title function_">mixInto</span>(<span class="title class_">ReactCompositeComponentBase</span>, <span class="title class_">ReactCompositeComponentMixin</span>);</span><br></pre></td></tr></table></figure>

<h3 id="React-autoBind-处理"><a href="#React-autoBind-处理" class="headerlink" title="React.autoBind 处理"></a>React.autoBind 处理</h3><p>简单介绍了这些后我们来看看， <code>mixSpecIntoComponent</code> 方法，既然看到这个方法，我们也要同样提到 <code>React.autoBind</code> 方法。本次我们仅讨论绑定上下文，不讨论其他相关：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactCompositeComponent.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactCompositeComponent</span> = &#123;</span><br><span class="line">  <span class="comment">// 使用 autoBind 的时候返回 unbound 函数</span></span><br><span class="line">  <span class="comment">// 将需要被绑定上下文的方法赋值至 __reactAutoBind</span></span><br><span class="line">  <span class="attr">autoBind</span>: <span class="keyword">function</span>(<span class="params">method</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">unbound</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">invariant</span>(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;React.autoBind(...): Attempted to invoke an auto-bound method that &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;was not correctly defined on the class specification.&#x27;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    unbound.<span class="property">__reactAutoBind</span> = method;</span><br><span class="line">    <span class="keyword">return</span> unbound;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mixSpecIntoComponent</span>(<span class="params">Constructor, spec</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> proto = <span class="title class_">Constructor</span>.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> spec) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!spec.<span class="title function_">hasOwnProperty</span>(name)) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> property = spec[name];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目前仅保留了与 autoBind 相关代码</span></span><br><span class="line">    <span class="comment">// 合并 specification 时，检查是否存在 __reactAutoBind 属性</span></span><br><span class="line">    <span class="comment">// 并加入 __reactAutoBindMap</span></span><br><span class="line">    <span class="keyword">if</span> (property &amp;&amp; property.<span class="property">__reactAutoBind</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!proto.<span class="property">__reactAutoBindMap</span>) &#123;</span><br><span class="line">        proto.<span class="property">__reactAutoBindMap</span> = &#123;&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      proto.<span class="property">__reactAutoBindMap</span>[name] = property.<span class="property">__reactAutoBind</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 其他属性正常合并</span></span><br><span class="line">      proto[name] = property;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactCompositeComponentMixin</span> = &#123;</span><br><span class="line">  <span class="attr">mountComponent</span>: <span class="keyword">function</span>(<span class="params">rootID, transaction</span>) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// 挂载组件时检查 __reactAutoBindMap 存在则执行 _bindAutoBindMethods 方法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">__reactAutoBindMap</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_bindAutoBindMethods</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">_bindAutoBindMethods</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 遍历 __reactAutoBindMap</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> autoBindKey <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">__reactAutoBindMap</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">__reactAutoBindMap</span>.<span class="title function_">hasOwnProperty</span>(autoBindKey)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 获取对应的方法</span></span><br><span class="line">      <span class="keyword">var</span> method = <span class="variable language_">this</span>.<span class="property">__reactAutoBindMap</span>[autoBindKey];</span><br><span class="line">      <span class="comment">// 重新返回被绑定过后的方法</span></span><br><span class="line">      <span class="variable language_">this</span>[autoBindKey] = <span class="variable language_">this</span>.<span class="title function_">_bindAutoBindMethod</span>(method);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">_bindAutoBindMethod</span>: <span class="keyword">function</span>(<span class="params">method</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取到当前的组件上下文作用域</span></span><br><span class="line">    <span class="keyword">var</span> component = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">var</span> hasWarned = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">autoBound</span>(<span class="params">a, b, c, d, e, tooMany</span>) &#123;</span><br><span class="line">      <span class="title function_">invariant</span>(</span><br><span class="line">        <span class="keyword">typeof</span> tooMany === <span class="string">&#x27;undefined&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;React.autoBind(...): Methods can only take a maximum of 5 arguments.&#x27;</span></span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// 判断组件声明周期为已挂载进行绑定</span></span><br><span class="line">      <span class="keyword">if</span> (component.<span class="property">_lifeCycleState</span> === <span class="title class_">ReactComponent</span>.<span class="property">LifeCycle</span>.<span class="property">MOUNTED</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> method.<span class="title function_">call</span>(component, a, b, c, d, e);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasWarned) &#123;</span><br><span class="line">        hasWarned = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">&#x27;React.autoBind(...): Attempted to invoke an auto-bound method &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;on an unmounted instance of `%s`. You either have a memory leak &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;or an event handler that is being run after unmounting.&#x27;</span>,</span><br><span class="line">            component.<span class="property">constructor</span>.<span class="property">displayName</span> || <span class="string">&#x27;ReactCompositeComponent&#x27;</span></span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> autoBound;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="卸载组件"><a href="#卸载组件" class="headerlink" title="卸载组件"></a>卸载组件</h2><p>那么到这里关于绑定组件上下文的内容也解读完了，既然有组件渲染（挂载），那么就有组件（移除）卸载，这里我们主要看到 <code>React.unmountAndReleaseReactRootNode</code> 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactMount.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactMount</span> = &#123;</span><br><span class="line">  <span class="attr">unmountAndReleaseReactRootNode</span>: <span class="keyword">function</span>(<span class="params">container</span>) &#123;</span><br><span class="line">    <span class="comment">// 意思很简单，获取 container 对应的 reactRootID</span></span><br><span class="line">    <span class="comment">// 从映射中找到对应的 component</span></span><br><span class="line">    <span class="keyword">var</span> reactRootID = <span class="title function_">getReactRootID</span>(container);</span><br><span class="line">    <span class="keyword">var</span> component = instanceByReactRootID[reactRootID];</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Consider throwing if no `component` was found.</span></span><br><span class="line">    <span class="comment">// 执行卸载方法</span></span><br><span class="line">    component.<span class="title function_">unmountComponentFromNode</span>(container);</span><br><span class="line">    <span class="comment">// 清除对应映射缓存</span></span><br><span class="line">    <span class="keyword">delete</span> instanceByReactRootID[reactRootID];</span><br><span class="line">    <span class="keyword">delete</span> containersByReactRootID[reactRootID];</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>unmountComponentFromNode</code> 方法我们看到 <code>ReactComponent.js</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactComponent.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactComponent</span> = &#123;</span><br><span class="line">  <span class="title class_">Mixin</span>: &#123;</span><br><span class="line">    <span class="attr">unmountComponentFromNode</span>: <span class="keyword">function</span>(<span class="params">container</span>) &#123;</span><br><span class="line">      <span class="comment">// 调用对应的 ReactNativeComponent 或 ReactCompositeComponent 组件的 unmountComponent 方法</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unmountComponent</span>();</span><br><span class="line">      <span class="comment">// http://jsperf.com/emptying-a-node</span></span><br><span class="line">      <span class="comment">// 遍历移除节点</span></span><br><span class="line">      <span class="keyword">while</span> (container.<span class="property">lastChild</span>) &#123;</span><br><span class="line">        container.<span class="title function_">removeChild</span>(container.<span class="property">lastChild</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">unmountComponent</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 释放内存相关，会被 ReactNativeComponent 或 ReactCompositeComponent 调起</span></span><br><span class="line">      <span class="title function_">invariant</span>(</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_lifeCycleState</span> === <span class="title class_">ComponentLifeCycle</span>.<span class="property">MOUNTED</span>,</span><br><span class="line">        <span class="string">&#x27;unmountComponent(): Can only unmount a mounted component.&#x27;</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">var</span> props = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line">      <span class="keyword">if</span> (props.<span class="property">ref</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">ReactOwner</span>.<span class="title function_">removeComponentAsRefFrom</span>(<span class="variable language_">this</span>, props.<span class="property">ref</span>, props[<span class="variable constant_">OWNER</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_rootNode</span> = <span class="literal">null</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_rootNodeID</span> = <span class="literal">null</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_lifeCycleState</span> = <span class="title class_">ComponentLifeCycle</span>.<span class="property">UNMOUNTED</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们来分别看下 <code>ReactNativeComponent</code> 或 <code>ReactCompositeComponent</code> 组件的 <code>unmountComponent</code> 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactNativeComponent.js</span></span><br><span class="line"><span class="title class_">ReactNativeComponent</span>.<span class="property">Mixin</span> = &#123;</span><br><span class="line">  <span class="attr">unmountComponent</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 释放内存</span></span><br><span class="line">    <span class="title class_">ReactComponent</span>.<span class="property">Mixin</span>.<span class="property">unmountComponent</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="comment">// 移除子节点，方法来自于 ReactMultiChild.unmountMultiChild</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">unmountMultiChild</span>();</span><br><span class="line">    <span class="comment">// 移除事件监听</span></span><br><span class="line">    <span class="title class_">ReactEvent</span>.<span class="title function_">deleteAllListeners</span>(<span class="variable language_">this</span>.<span class="property">_rootNodeID</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="遍历卸载子组件"><a href="#遍历卸载子组件" class="headerlink" title="遍历卸载子组件"></a>遍历卸载子组件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactMultiChild.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactMultiChildMixin</span> = &#123;</span><br><span class="line">  <span class="attr">unmountMultiChild</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> renderedChildren = <span class="variable language_">this</span>.<span class="property">_renderedChildren</span>;</span><br><span class="line">    <span class="comment">// 遍历卸载</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> renderedChildren) &#123;</span><br><span class="line">      <span class="keyword">if</span> (renderedChildren.<span class="title function_">hasOwnProperty</span>(name) &amp;&amp; renderedChildren[name]) &#123;</span><br><span class="line">        <span class="keyword">var</span> renderedChild = renderedChildren[name];</span><br><span class="line">        renderedChild.<span class="property">unmountComponent</span> &amp;&amp; renderedChild.<span class="title function_">unmountComponent</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 释放内存</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_renderedChildren</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactCompositeComponent.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactCompositeComponentMixin</span> = &#123;</span><br><span class="line">  <span class="attr">unmountComponent</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_compositeLifeCycleState</span> = <span class="title class_">CompositeLifeCycle</span>.<span class="property">UNMOUNTING</span>;</span><br><span class="line">    <span class="comment">// 执行生命周期</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">componentWillUnmount</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">componentWillUnmount</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_compositeLifeCycleState</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">ReactComponent</span>.<span class="property">Mixin</span>.<span class="property">unmountComponent</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="comment">// 执行 ReactNativeComponent.unmountComponent</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_renderedComponent</span>.<span class="title function_">unmountComponent</span>();</span><br><span class="line">    <span class="comment">// 释放内存</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_renderedComponent</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">refs</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">refs</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some existing components rely on this.props even after they&#x27;ve been</span></span><br><span class="line">    <span class="comment">// destroyed (in event handlers).</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> this.props = null;</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> this.state = null;</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>那么到此，实现组件渲染功能。</p>
<hr>
<h2 id="验证组件方法"><a href="#验证组件方法" class="headerlink" title="验证组件方法"></a>验证组件方法</h2><p>这里还有一点需要提的到是 <code>React.isValidComponent</code> 方法，用来校验是否为 React 组件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactComponent.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactComponent</span> = &#123;</span><br><span class="line">  <span class="attr">isValidComponent</span>: <span class="keyword">function</span>(<span class="params">object</span>) &#123;</span><br><span class="line">    <span class="comment">// 鸭子类型校验法</span></span><br><span class="line">    <span class="comment">// object 存在切具有 mountComponentIntoNode 方法 和 receiveProps 方法</span></span><br><span class="line">    <span class="keyword">return</span> !!(</span><br><span class="line">      object &amp;&amp;</span><br><span class="line">      <span class="keyword">typeof</span> object.<span class="property">mountComponentIntoNode</span> === <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">      <span class="keyword">typeof</span> object.<span class="property">receiveProps</span> === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

                </div>
            </div>

            
            <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者: </strong>
    Zong
  </li>
  <li class="post-copyright-link">
    <strong>本文链接: </strong>
    <a href="https://zongzi531.com/2019/04/06/LSC-React-06/" title="React 源码学习（六）：组件渲染">https://zongzi531.com/2019/04/06/LSC-React-06/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明: </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

            
    
            <nav class="post-pagination">
    
    <a class="newer-posts" href="/2019/04/07/LSC-React-07/">
        上一篇<br>React 源码学习（七）：生命周期
    </a>
    
    <span class="page-number"></span>
    
    <a class="older-posts" href="/2019/04/05/LSC-React-05/">
        下一篇<br>React 源码学习（五）：事件机制
    </a>
    
</nav>

    
            

<div class="post-comment-wrapper">
    <div class="giscus"></div>
</div>


        </div>
    </div>
    <div class="single-column-footer">
    <div style="margin-bottom: 8px;">
        <a title="GitHub" target="_blank" rel="noopener" href="https://github.com/zongzi531" style="margin: 0px 2px;"><svg height="16" width="16" viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a>
        <a title="知乎" target="_blank" rel="noopener" href="https://www.zhihu.com/people/zongzi531/posts" style="margin: 0px 2px;"><img height="16" src="https://static.zhihu.com/static/favicon.ico"></a>
        <a title="掘金" target="_blank" rel="noopener" href="https://juejin.im/user/58747cf2ac502e00646e3b8b/posts" style="margin: 0px 2px;"><img height="16" src="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/favicons/favicon-32x32.png"></a>
        <a title="力扣" target="_blank" rel="noopener" href="https://leetcode-cn.com/u/zongzi0531/" style="margin: 0px 2px;"><img height="16" src="https://static.leetcode-cn.com/cn-assets/icons/favicon-32x32.png"></a>
    </div>
    &copy; 2017 - 2023 <a href="https://zongzi531.com">Zong</a>
</div>
</div>

</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"
        integrity="sha256-EGs9T1xMHdvM1geM8jPpoo8EZ1V1VRsmcJz8OByENLA=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"
        integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"
        integrity="sha256-FtWfRI+thWlNz2sB3SJbwKx5PgMyKIVgwHCTwa3biXc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@14.2.1/dist/smooth-scroll.polyfills.min.js"
        integrity="sha256-CI4Gq5E0io1Pv0xM3qPM+NUIOhbIBvC3GiN1Y4KhXpw=" crossorigin="anonymous"></script>
<script src="/js/journal.js?8598401"></script>


    <script src="https://giscus.app/client.js"
    data-repo="zongzi531/zongzi531.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkyMTgyODY2MjA="
    data-category="General"
    data-category-id="DIC_kwDODQLKHM4COlHH"
    data-mapping="url"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
</script>


</body>
</html>
