

<!DOCTYPE html>
<html lang="zh-CN" xmlns:v-bind="http://www.w3.org/1999/xhtml">

<head>
    <title>React 源码学习（五）：事件机制 - Zong</title>
<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Zong">
<meta name="description" content="




阅读源码成了今年的学习目标之一，在选择 Vue 和 React 之间，我想先阅读 React 。在考虑到...">
<meta name="keywords" content="Blog JavaScript TypeScript Front-end CSS">

    <meta charset="utf-8">
    <meta name="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta name="renderer" content="webkit">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/journal.css?92968603">

<link rel="icon" href="/images/favicon.ico">

<script src="/js/loadCSS.js"></script>
<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Material+Icons");
    (function(d) {
        var config = {
        kitId: 'ojl5tfq',
        scriptTimeout: 3000,
        async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
    })(document);
</script>
<noscript>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Anonymous+Pro:400|Material+Icons"/>
</noscript>
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="Zong" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-material-oceanic.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
<body>
<div id="top"></div>
<div id="app">
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            <a class="a-block drawer-menu-item false" href="https://zongzi531.com">
                首页
            </a>
            

            
            
                
                    <a class="a-block drawer-menu-item false" href="/commuting/index.html">
                        通勤那点事
                    </a>
                
            
                
            
                
            
                
            
                
                    <a class="a-block drawer-menu-item false" href="/bangumi/index.html">
                        番組
                    </a>
                
            
                
                    <a class="a-block drawer-menu-item false" href="/nihongonokona/index.html">
                        日本語のコーナー
                    </a>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
                    <a class="a-block drawer-menu-item false" href="/syoukai/index.html">
                        紹介
                    </a>
                
            
                
            

            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="/">
            Zong
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="/">
        <div class="single-column-header-title">Zong</div>
        <div class="single-column-header-subtitle"></div>
    </a>
</div>
<div ref="sideContainer" class="side-container">
    <a class="a-block nav-head false" href="/">
        <div class="nav-title">
            Zong
        </div>
        <div class="nav-subtitle">
            人之所以能<br>，是相信能
        </div>
    </a>

    <div class="nav-link-list">
        

        
        
            
                <a class="a-block nav-link-item false" href="/commuting/index.html">
                    通勤那点事
                </a>
            
        
            
        
            
        
            
        
            
                <a class="a-block nav-link-item false" href="/bangumi/index.html">
                    番組
                </a>
            
        
            
                <a class="a-block nav-link-item false" href="/nihongonokona/index.html">
                    日本語のコーナー
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
                <a class="a-block nav-link-item false" href="/syoukai/index.html">
                    紹介
                </a>
            
        
            
        

        
    </div>

    <div class="nav-footer">
        <div style="margin-bottom: 8px;">
            <a title="GitHub" target="_blank" rel="noopener" href="https://github.com/zongzi531" style="margin: 0px 2px;"><svg height="16" width="16" viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a>
            <a title="知乎" target="_blank" rel="noopener" href="https://www.zhihu.com/people/zongzi531/posts" style="margin: 0px 2px;"><img height="16" src="https://static.zhihu.com/static/favicon.ico"></a>
            <a title="掘金" target="_blank" rel="noopener" href="https://juejin.im/user/58747cf2ac502e00646e3b8b/posts" style="margin: 0px 2px;"><img height="16" src="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/favicons/favicon-32x32.png"></a>
            <a title="力扣" target="_blank" rel="noopener" href="https://leetcode-cn.com/u/zongzi0531/" style="margin: 0px 2px;"><img height="16" src="https://static.leetcode-cn.com/cn-assets/icons/favicon-32x32.png"></a>
        </div>
        &copy; 2017 - 2023 <a href="https://zongzi531.com">Zong</a>
    </div>
</div>
<div ref="extraContainer" class="extra-container">
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>

        
    </div>
</div>



<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            <div class="post-head-wrapper-text-only"
                 style="background-image: url('')">
                <div class="post-title">
                    React 源码学习（五）：事件机制
                    <div class="post-meta">
                        <time datetime="2019-04-05T08:25:52.000Z" itemprop="datePublished">
                            2019-04-05 08:25
                        </time>&nbsp;
                        
                        
                        <i class="material-icons" style="">folder</i>
                        
                        <a href='/categories/React-源码学习/'>React 源码学习</a>
                        
                        
    
                        
                        
                        <i class="material-icons" style="">label</i>
                        
                        <a href='/tags/React/'>React</a>
                        
                        
                    </div>
                </div>
            </div>
    
            <div class="post-body-wrapper">
                <div class="post-body">
                    <!-- no node -->

<span id="more"></span>

<blockquote>
<p>阅读源码成了今年的学习目标之一，在选择 Vue 和 React 之间，我想先阅读 React 。<br>在考虑到读哪个版本的时候，我想先接触到源码早期的思想可能会更轻松一些，最终我选择阅读 <code>0.3-stable</code> 。<br>那么接下来，我将从几个方面来解读这个版本的源码。</p>
</blockquote>
<ol>
<li><a href="https://zongzi531.com/2019/04/01/LSC-React-01/">React 源码学习（一）：HTML 元素渲染</a></li>
<li><a href="https://zongzi531.com/2019/04/02/LSC-React-02/">React 源码学习（二）：HTML 子元素渲染</a></li>
<li><a href="https://zongzi531.com/2019/04/03/LSC-React-03/">React 源码学习（三）：CSS 样式及 DOM 属性</a></li>
<li><a href="https://zongzi531.com/2019/04/04/LSC-React-04/">React 源码学习（四）：事务机制</a></li>
<li><a href="https://zongzi531.com/2019/04/05/LSC-React-05/">React 源码学习（五）：事件机制</a></li>
<li><a href="https://zongzi531.com/2019/04/06/LSC-React-06/">React 源码学习（六）：组件渲染</a></li>
<li><a href="https://zongzi531.com/2019/04/07/LSC-React-07/">React 源码学习（七）：生命周期</a></li>
<li><a href="https://zongzi531.com/2019/04/08/LSC-React-08/">React 源码学习（八）：组件更新</a></li>
<li><a href="https://zongzi531.com/2019/12/18/LSC-React-09/">React 源码学习（九）：“脱胎换骨”</a></li>
<li><a href="https://zongzi531.com/2019/12/19/LSC-React-10/">React 源码学习（十）：Fiber</a></li>
<li><a href="https://zongzi531.com/2019/12/20/LSC-React-11/">React 源码学习（十一）：Scheduling</a></li>
<li><a href="https://zongzi531.com/2019/12/21/LSC-React-12/">React 源码学习（十二）：Reconciliation</a></li>
</ol>
<h2 id="React-事件"><a href="#React-事件" class="headerlink" title="React 事件"></a>React 事件</h2><p>我们先来看到整体逻辑图：</p>
<p><img src="/2019/04/05/LSC-React-05/05-01.png" alt="事件机制"></p>
<p>React 采用将事件挂载至 <code>document</code> 或者 <code>window</code> 上来实现顶级事件。接下来我们会一一来介绍事件的实现过程。</p>
<h3 id="事件插件注入"><a href="#事件插件注入" class="headerlink" title="事件插件注入"></a>事件插件注入</h3><p>我们来回忆下， <code>ReactNativeComponent.js</code> 中 <code>_createOpenTagMarkup</code> 方法中的 <code>putListener</code> 函数和 <code>ReactMount.js</code> 中 <code>renderComponent</code> 方法中的 <code>prepareTopLevelEvents</code> 函数都是事件相关的方法，前者是生成 HTML 标记时，对符合要求的“键”进行注册事件，后者则是在执行 <code>React.renderComponent</code> 方法时进行准备顶级事件的过程。当然之前有一个内容没有提到，就是在 React 注入时，默认注入了事件插件排序顺序、实例操作函数、事件插件。那让我们直接先看到代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactDefaultInjection.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">inject</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 注入模块，用于解析DOM层次结构和插件排序。</span></span><br><span class="line">  <span class="comment">// 这里是注入事件插件排序顺序</span></span><br><span class="line">  <span class="title class_">EventPluginHub</span>.<span class="property">injection</span>.<span class="title function_">injectEventPluginOrder</span>(<span class="title class_">DefaultEventPluginOrder</span>);</span><br><span class="line">  <span class="comment">// 注入实例操作函数，用于事件传播</span></span><br><span class="line">  <span class="title class_">EventPluginHub</span>.<span class="property">injection</span>.<span class="title function_">injectInstanceHandle</span>(<span class="title class_">ReactInstanceHandles</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认包含两个重要事件插件（而不必要求他们）。</span></span><br><span class="line">  <span class="comment">// 注入事件插件</span></span><br><span class="line">  <span class="title class_">EventPluginHub</span>.<span class="property">injection</span>.<span class="title function_">injectEventPluginsByName</span>(&#123;</span><br><span class="line">    <span class="string">&#x27;SimpleEventPlugin&#x27;</span>: <span class="title class_">SimpleEventPlugin</span>,</span><br><span class="line">    <span class="string">&#x27;EnterLeaveEventPlugin&#x27;</span>: <span class="title class_">EnterLeaveEventPlugin</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用于兼容 IE8 创建的复合组件，后续讲到组件的时候再做解读，但不对 `ReactDOMForm.js` 进行解读</span></span><br><span class="line">  <span class="title class_">ReactDOM</span>.<span class="property">injection</span>.<span class="title function_">injectComponentClasses</span>(&#123;</span><br><span class="line">    <span class="attr">form</span>: <span class="title class_">ReactDOMForm</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然你需要知道，这个 <code>inject</code> 函数时需要在 <code>React.js</code> 中引入并执行的。</p>
<p>我们一步步往下看。先来看看 <code>DefaultEventPluginOrder.js</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eventPlugins/DefaultEventPluginOrder.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">DefaultEventPluginOrder</span> = [</span><br><span class="line">  <span class="title function_">keyOf</span>(&#123;<span class="title class_">ResponderEventPlugin</span>: <span class="literal">null</span>&#125;),</span><br><span class="line">  <span class="title function_">keyOf</span>(&#123;<span class="title class_">SimpleEventPlugin</span>: <span class="literal">null</span>&#125;),</span><br><span class="line">  <span class="title function_">keyOf</span>(&#123;<span class="title class_">TapEventPlugin</span>: <span class="literal">null</span>&#125;),</span><br><span class="line">  <span class="title function_">keyOf</span>(&#123;<span class="title class_">EnterLeaveEventPlugin</span>: <span class="literal">null</span>&#125;),</span><br><span class="line">  <span class="title function_">keyOf</span>(&#123;<span class="title class_">AnalyticsEventPlugin</span>: <span class="literal">null</span>&#125;)</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>就是一个事件插件的默认顺序列表，使用 <code>EventPluginHub.injection.injectEventPluginOrder</code> 方法进行注入。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event/EventPluginHub.js</span></span><br><span class="line"><span class="keyword">var</span> injection = &#123;</span><br><span class="line">  <span class="title class_">EventPluginOrder</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">injectEventPluginOrder</span>: <span class="keyword">function</span>(<span class="params">InjectedEventPluginOrder</span>) &#123;</span><br><span class="line">    injection.<span class="property">EventPluginOrder</span> = <span class="title class_">InjectedEventPluginOrder</span>;</span><br><span class="line">    <span class="comment">// 这个方法稍后再做解读，因为 injectEventPluginsByName 方法也使用到了他</span></span><br><span class="line">    injection.<span class="title function_">_recomputePluginsList</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>EventPluginHub.injection.injectInstanceHandle(ReactInstanceHandles);</code> 也是差不多的操作，他操作的是 <code>EventPropagators.js</code> 下的 <code>InstanceHandle</code> 。 <code>ReactInstanceHandles</code> 在后续事件相关中都会使用到。我们先来看看 <code>injectEventPluginsByName</code> 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event/EventPluginHub.js</span></span><br><span class="line"><span class="keyword">var</span> injection = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [],</span><br><span class="line">  <span class="attr">injectEventPluginsByName</span>: <span class="keyword">function</span>(<span class="params">pluginsByName</span>) &#123;</span><br><span class="line">    <span class="comment">// 这里讲传入插件与已存插件进行合并</span></span><br><span class="line">    injection.<span class="property">pluginsByName</span> = <span class="title function_">merge</span>(injection.<span class="property">pluginsByName</span>, pluginsByName);</span><br><span class="line">    injection.<span class="title function_">_recomputePluginsList</span>();</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">pluginsByName</span>: &#123;&#125;,</span><br><span class="line">  <span class="comment">// 重新计算事件插件顺序列表</span></span><br><span class="line">  <span class="attr">_recomputePluginsList</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> injectPluginByName = <span class="keyword">function</span>(<span class="params">name, PluginModule</span>) &#123;</span><br><span class="line">      <span class="comment">// 查找插件顺序列表，不存在则抛出错误</span></span><br><span class="line">      <span class="keyword">var</span> pluginIndex = injection.<span class="property">EventPluginOrder</span>.<span class="title function_">indexOf</span>(name);</span><br><span class="line">      <span class="title function_">throwIf</span>(pluginIndex === -<span class="number">1</span>, <span class="variable constant_">ERRORS</span>.<span class="property">DEPENDENCY_ERROR</span> + name);</span><br><span class="line">      <span class="comment">// 对应的插件列表不存在的情况，则在对应索引赋值其对应的插件模块</span></span><br><span class="line">      <span class="keyword">if</span> (!injection.<span class="property">plugins</span>[pluginIndex]) &#123;</span><br><span class="line">        injection.<span class="property">plugins</span>[pluginIndex] = <span class="title class_">PluginModule</span>;</span><br><span class="line">        <span class="comment">// 遍历其插件模块对应的抽象事件类型</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> eventName <span class="keyword">in</span> <span class="title class_">PluginModule</span>.<span class="property">abstractEventTypes</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> eventType = <span class="title class_">PluginModule</span>.<span class="property">abstractEventTypes</span>[eventName];</span><br><span class="line">          <span class="comment">// 记录所有的注册名称</span></span><br><span class="line">          <span class="title function_">recordAllRegistrationNames</span>(eventType, <span class="title class_">PluginModule</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 事件插件的默认顺序列表存在情况</span></span><br><span class="line">    <span class="keyword">if</span> (injection.<span class="property">EventPluginOrder</span>) &#123;  <span class="comment">// Else, do when plugin order injected</span></span><br><span class="line">      <span class="keyword">var</span> injectedPluginsByName = injection.<span class="property">pluginsByName</span>;</span><br><span class="line">      <span class="comment">// 遍历注入的插件</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> injectedPluginsByName) &#123;</span><br><span class="line">        <span class="title function_">injectPluginByName</span>(name, injectedPluginsByName[name]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> registrationNames = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> registrationNamesArr = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">recordAllRegistrationNames</span>(<span class="params">eventType, PluginModule</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> phaseName;</span><br><span class="line">  <span class="comment">// 从 eventType 获得 phasedRegistrationNames</span></span><br><span class="line">  <span class="keyword">var</span> phasedRegistrationNames = eventType.<span class="property">phasedRegistrationNames</span>;</span><br><span class="line">  <span class="comment">// 查看相关源码可以发现，这里适用于 `SimpleEventPlugin`</span></span><br><span class="line">  <span class="keyword">if</span> (phasedRegistrationNames) &#123;</span><br><span class="line">    <span class="comment">// 遍历 phasedRegistrationNames</span></span><br><span class="line">    <span class="keyword">for</span> (phaseName <span class="keyword">in</span> phasedRegistrationNames) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!phasedRegistrationNames.<span class="title function_">hasOwnProperty</span>(phaseName)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 对应位置进行添加</span></span><br><span class="line">      registrationNames[phasedRegistrationNames[phaseName]] = <span class="title class_">PluginModule</span>;</span><br><span class="line">      registrationNamesArr.<span class="title function_">push</span>(phasedRegistrationNames[phaseName]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventType.<span class="property">registrationName</span>) &#123;</span><br><span class="line">    <span class="comment">// 若注册名称在的情况，查看相关源码可以发现，这里适用于 `EnterLeaveEventPlugin`</span></span><br><span class="line">    registrationNames[eventType.<span class="property">registrationName</span>] = <span class="title class_">PluginModule</span>;</span><br><span class="line">    registrationNamesArr.<span class="title function_">push</span>(eventType.<span class="property">registrationName</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 看到源码项目结构或者事件插件的默认顺序列表你都会发现，有着 `ResponderEventPlugin`</span></span><br><span class="line">  <span class="comment">// `TapEventPlugin`, `AnalyticsEventPlugin` 的存在。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比较抽象对吧，因为这里操作的都是事件插件的默认顺序列表中的对象，我们接下来看到 <code>SimpleEventPlugin</code> 和 <code>EnterLeaveEventPlugin</code> 来做相应的解释：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eventPlugins/SimpleEventPlugin.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">SimpleEventPlugin</span> = &#123;</span><br><span class="line">  <span class="attr">abstractEventTypes</span>: &#123;</span><br><span class="line">    <span class="comment">// Note: We do not allow listening to mouseOver events. Instead, use the</span></span><br><span class="line">    <span class="comment">// onMouseEnter/onMouseLeave created by `EnterLeaveEventPlugin`.</span></span><br><span class="line">    <span class="comment">// 这里提到 onMouseEnter/onMouseLeave 请查看到 `EnterLeaveEventPlugin.js`</span></span><br><span class="line">    <span class="attr">mouseDown</span>: &#123;</span><br><span class="line">      <span class="comment">// 这是上面注册所有事件名称使用到的位置</span></span><br><span class="line">      <span class="attr">phasedRegistrationNames</span>: &#123;</span><br><span class="line">        <span class="attr">bubbled</span>: <span class="title function_">keyOf</span>(&#123;<span class="attr">onMouseDown</span>: <span class="literal">true</span>&#125;),</span><br><span class="line">        <span class="attr">captured</span>: <span class="title function_">keyOf</span>(&#123;<span class="attr">onMouseDownCapture</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eventPlugins/EnterLeaveEventPlugin.js</span></span><br><span class="line"><span class="keyword">var</span> abstractEventTypes = &#123;</span><br><span class="line">  <span class="attr">mouseEnter</span>: &#123;<span class="attr">registrationName</span>: <span class="title function_">keyOf</span>(&#123;<span class="attr">onMouseEnter</span>: <span class="literal">null</span>&#125;)&#125;,</span><br><span class="line">  <span class="attr">mouseLeave</span>: &#123;<span class="attr">registrationName</span>: <span class="title function_">keyOf</span>(&#123;<span class="attr">onMouseLeave</span>: <span class="literal">null</span>&#125;)&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>那么从中获取相应的对象如 <code>phasedRegistrationNames</code> 或是对应的标识 <code>registrationName</code>。</p>
<h2 id="注册顶级事件"><a href="#注册顶级事件" class="headerlink" title="注册顶级事件"></a>注册顶级事件</h2><p>我们现在来看到 <code>ReactMount.js</code> 中 <code>renderComponent</code> 方法中的 <code>prepareTopLevelEvents</code> 函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactMount.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactMount</span> = &#123;</span><br><span class="line">  <span class="attr">useTouchEvents</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">prepareTopLevelEvents</span>: <span class="keyword">function</span>(<span class="params">TopLevelCallbackCreator</span>) &#123;</span><br><span class="line">    <span class="title class_">ReactEvent</span>.<span class="title function_">ensureListening</span>(</span><br><span class="line">      <span class="comment">// 用于控制是否使用 TouchEvents ， 默认为 false</span></span><br><span class="line">      <span class="title class_">ReactMount</span>.<span class="property">useTouchEvents</span>,</span><br><span class="line">      <span class="title class_">TopLevelCallbackCreator</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但是你可以调用 <code>React.initializeTouchEvents(true);</code> 来提前开启他，当然这是你需要使用到他的时候。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactEvent.js</span></span><br><span class="line"><span class="keyword">var</span> _isListening = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ensureListening</span>(<span class="params">touchNotMouse, TopLevelCallbackCreator</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!_isListening) &#123;</span><br><span class="line">    <span class="comment">// 赋值顶级回调创建者</span></span><br><span class="line">    <span class="title class_">ReactEvent</span>.<span class="property">TopLevelCallbackCreator</span> = <span class="title class_">TopLevelCallbackCreator</span>;</span><br><span class="line">    <span class="title function_">listenAtTopLevel</span>(touchNotMouse);</span><br><span class="line">    <span class="comment">// 一个私有变量，用于控制 ensureListening 方法只执行一次</span></span><br><span class="line">    _isListening = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">listenAtTopLevel</span>(<span class="params">touchNotMouse</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> mountAt = <span class="variable language_">document</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">registerDocumentScrollListener</span>();</span><br><span class="line">  <span class="title function_">registerDocumentResizeListener</span>();</span><br><span class="line">  <span class="title function_">trapBubbledEvent</span>(topLevelTypes.<span class="property">topMouseOver</span>, <span class="string">&#x27;mouseover&#x27;</span>, mountAt);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// TouchEvents 相关</span></span><br><span class="line">  <span class="keyword">if</span> (touchNotMouse) &#123;</span><br><span class="line">    <span class="title function_">trapBubbledEvent</span>(topLevelTypes.<span class="property">topTouchStart</span>, <span class="string">&#x27;touchstart&#x27;</span>, mountAt);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ... 以及一些兼容相关，涉及使用到 `isEventSupported` 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event/EventConstants.js</span></span><br><span class="line"><span class="keyword">var</span> topLevelTypes = <span class="title function_">keyMirror</span>(&#123;</span><br><span class="line">  <span class="attr">topBlur</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="捕获-冒泡事件监听"><a href="#捕获-冒泡事件监听" class="headerlink" title="捕获&#x2F;冒泡事件监听"></a>捕获&#x2F;冒泡事件监听</h3><p>上面代码直接完成顶级事件的监听，我们顺势来看看 <code>trapBubbledEvent</code> ，与之相关的还有 <code>trapCapturedEvent</code> ，分别是冒泡和捕获阶段：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactEvent.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trapBubbledEvent</span>(<span class="params">topLevelType, handlerBaseName, onWhat</span>) &#123;</span><br><span class="line">  <span class="title function_">listen</span>(</span><br><span class="line">    onWhat,</span><br><span class="line">    handlerBaseName,</span><br><span class="line">    <span class="title class_">ReactEvent</span>.<span class="property">TopLevelCallbackCreator</span>.<span class="title function_">createTopLevelCallback</span>(topLevelType)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trapCapturedEvent</span>(<span class="params">topLevelType, handlerBaseName, onWhat</span>) &#123;</span><br><span class="line">  <span class="title function_">capture</span>(</span><br><span class="line">    onWhat,</span><br><span class="line">    handlerBaseName,</span><br><span class="line">    <span class="title class_">ReactEvent</span>.<span class="property">TopLevelCallbackCreator</span>.<span class="title function_">createTopLevelCallback</span>(topLevelType)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实从这里你就可以发现，不管是冒泡或者是捕获，我在 <code>document</code> 或者 <code>window</code> 这样的顶级对象上，都会先被捕获到，至于最后想到哪个方法或者函数，那么是由事件传播器控制，查找对应的回调注册表来完成功能。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event/NormalizedEventListener.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createNormalizedCallback</span>(<span class="params">cb</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">unfixedNativeEvent</span>) &#123;</span><br><span class="line">    <span class="title function_">cb</span>(<span class="title function_">normalizeEvent</span>(unfixedNativeEvent));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">NormalizedEventListener</span> = &#123;</span><br><span class="line">  <span class="attr">listen</span>: <span class="keyword">function</span>(<span class="params">el, handlerBaseName, cb</span>) &#123;</span><br><span class="line">    <span class="title class_">EventListener</span>.<span class="title function_">listen</span>(el, handlerBaseName, <span class="title function_">createNormalizedCallback</span>(cb));</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">capture</span>: <span class="keyword">function</span>(<span class="params">el, handlerBaseName, cb</span>) &#123;</span><br><span class="line">    <span class="title class_">EventListener</span>.<span class="title function_">capture</span>(el, handlerBaseName, <span class="title function_">createNormalizedCallback</span>(cb));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>normalizeEvent</code> 函数是一个补丁，这里不做解读。你可以直接忽略理解为 <code>cb(unfixedNativeEvent);</code> 。这里调用的又是另一个模块 <code>EventListener</code> ， <code>EventListener</code> 则的对原生浏览器 API 进行了封装。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/stubs/EventListener.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">EventListener</span> = &#123;</span><br><span class="line">  <span class="attr">listen</span>: <span class="keyword">function</span>(<span class="params">el, handlerBaseName, cb</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (el.<span class="property">addEventListener</span>) &#123;</span><br><span class="line">      el.<span class="title function_">addEventListener</span>(handlerBaseName, cb, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">attachEvent</span>) &#123;</span><br><span class="line">      el.<span class="title function_">attachEvent</span>(<span class="string">&#x27;on&#x27;</span> + handlerBaseName, cb);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">capture</span>: <span class="keyword">function</span>(<span class="params">el, handlerBaseName, cb</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!el.<span class="property">addEventListener</span>) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      el.<span class="title function_">addEventListener</span>(handlerBaseName, cb, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="React-顶级事件回调方法"><a href="#React-顶级事件回调方法" class="headerlink" title="React 顶级事件回调方法"></a>React 顶级事件回调方法</h2><p>那么由此可以看出， <code>trapBubbledEvent</code> 在操作的其实就是 <code>addEventListener</code> API，唯独还没有解读的是 <code>ReactEvent.TopLevelCallbackCreator.createTopLevelCallback(topLevelType)</code> ，其实你会发现，从刚刚开始我都没有解读 <code>TopLevelCallbackCreator</code> ，那么我们现在就来聊聊：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactEventTopLevelCallback.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactEventTopLevelCallback</span> = &#123;</span><br><span class="line">  <span class="comment">// 这里的 `topLevelType` 的值已经在 `listenAtTopLevel` 函数执行阶段就完成了赋值</span></span><br><span class="line">  <span class="comment">// 当 `addEventListener` 执行后，返回的是 `unfixedNativeEvent` 参数</span></span><br><span class="line">  <span class="comment">// 经过由 `normalizeEvent` 补丁处理后，返回 `fixedNativeEvent`</span></span><br><span class="line">  <span class="attr">createTopLevelCallback</span>: <span class="keyword">function</span>(<span class="params">topLevelType</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">fixedNativeEvent</span>) &#123;</span><br><span class="line">      <span class="comment">// 这个在之前也有提到过，当执行 React 调度事务时，将控制事件</span></span><br><span class="line">      <span class="keyword">if</span> (!_topLevelListenersEnabled) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 获得第一个 React DOM</span></span><br><span class="line">      <span class="keyword">var</span> renderedTarget = <span class="title class_">ReactInstanceHandles</span>.<span class="title function_">getFirstReactDOM</span>(</span><br><span class="line">        fixedNativeEvent.<span class="property">target</span></span><br><span class="line">      ) || <span class="title class_">ExecutionEnvironment</span>.<span class="property">global</span>;</span><br><span class="line">      <span class="comment">// 获得对应的 ID</span></span><br><span class="line">      <span class="keyword">var</span> renderedTargetID = <span class="title function_">getDOMNodeID</span>(renderedTarget);</span><br><span class="line">      <span class="keyword">var</span> event = fixedNativeEvent;</span><br><span class="line">      <span class="keyword">var</span> target = renderedTarget;</span><br><span class="line">      <span class="comment">// 例如： ReactEvent.handleTopLevel(&#x27;topClick&#x27;, event, &#x27;.reactRoot[0]&#x27;, target)</span></span><br><span class="line">      <span class="title class_">ReactEvent</span>.<span class="title function_">handleTopLevel</span>(topLevelType, event, renderedTargetID, target);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="创建抽象事件及执行至销毁"><a href="#创建抽象事件及执行至销毁" class="headerlink" title="创建抽象事件及执行至销毁"></a>创建抽象事件及执行至销毁</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactEvent.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleTopLevel</span>(<span class="params"></span></span><br><span class="line"><span class="params">    topLevelType,</span></span><br><span class="line"><span class="params">    nativeEvent,</span></span><br><span class="line"><span class="params">    renderedTargetID,</span></span><br><span class="line"><span class="params">    renderedTarget</span>) &#123;</span><br><span class="line">  <span class="comment">// 提取抽象事件，返回 AbstractEvents 实例</span></span><br><span class="line">  <span class="comment">// 这个抽象事件可能是 AbstractEvents 或者可能是 AbstractEvents[]</span></span><br><span class="line">  <span class="keyword">var</span> abstractEvents = <span class="title class_">EventPluginHub</span>.<span class="title function_">extractAbstractEvents</span>(</span><br><span class="line">    topLevelType,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    renderedTargetID,</span><br><span class="line">    renderedTarget</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The event queue being processed in the same cycle allows preventDefault.</span></span><br><span class="line">  <span class="comment">// 加入抽象事件队列</span></span><br><span class="line">  <span class="title class_">EventPluginHub</span>.<span class="title function_">enqueueAbstractEvents</span>(abstractEvents);</span><br><span class="line">  <span class="title class_">EventPluginHub</span>.<span class="title function_">processAbstractEventQueue</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event/EventPluginHub.js</span></span><br><span class="line"><span class="keyword">var</span> extractAbstractEvents = <span class="keyword">function</span>(<span class="params">topLevelType, nativeEvent, renderedTargetID, renderedTarget</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> abstractEvents;</span><br><span class="line">  <span class="comment">// 重新计算的 plugins 列表，就是执行 _recomputePluginsList 函数后的结果</span></span><br><span class="line">  <span class="keyword">var</span> plugins = injection.<span class="property">plugins</span>;</span><br><span class="line">  <span class="keyword">var</span> len = plugins.<span class="property">length</span>;</span><br><span class="line">  <span class="comment">// 遍历插件列表</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="comment">// Not every plugin in the ordering may be loaded at runtime.</span></span><br><span class="line">    <span class="keyword">var</span> possiblePlugin = plugins[i];</span><br><span class="line">    <span class="comment">// possiblePlugin 存在的情况下执行</span></span><br><span class="line">    <span class="comment">// 这里的 extractAbstractEvents 方法是 possiblePlugin 的</span></span><br><span class="line">    <span class="comment">// 比如 SimpleEventPlugin.extractAbstractEvents 方法</span></span><br><span class="line">    <span class="comment">// 对 SimpleEventPlugin.extractAbstractEvents 或者是 EnterLeaveEventPlugin.extractAbstractEvents</span></span><br><span class="line">    <span class="comment">// 这里不做具体解读，但是需要提到的是，进过函数返回的内容是 AbstractEvent 的实例，他使用 PooledClass 注入过</span></span><br><span class="line">    <span class="comment">// 可以直接调用 getPooled 及 release 方法</span></span><br><span class="line">    <span class="keyword">var</span> extractedAbstractEvents =</span><br><span class="line">      possiblePlugin &amp;&amp;</span><br><span class="line">      possiblePlugin.<span class="title function_">extractAbstractEvents</span>(</span><br><span class="line">        topLevelType,</span><br><span class="line">        nativeEvent,</span><br><span class="line">        renderedTargetID,</span><br><span class="line">        renderedTarget</span><br><span class="line">      );</span><br><span class="line">    <span class="comment">// 若最终这个返回值存在</span></span><br><span class="line">    <span class="keyword">if</span> (extractedAbstractEvents) &#123;</span><br><span class="line">      <span class="comment">// 合并 abstractEvents 和 extractedAbstractEvents</span></span><br><span class="line">      abstractEvents = <span class="title function_">accumulate</span>(abstractEvents, extractedAbstractEvents);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> abstractEvents;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> abstractEventQueue = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> enqueueAbstractEvents = <span class="keyword">function</span>(<span class="params">abstractEvents</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (abstractEvents) &#123;</span><br><span class="line">    <span class="comment">// 对这个抽象事件队列进行合并</span></span><br><span class="line">    abstractEventQueue = <span class="title function_">accumulate</span>(abstractEventQueue, abstractEvents);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> processAbstractEventQueue = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> processingAbstractEventQueue = abstractEventQueue;</span><br><span class="line">  <span class="comment">// 释放内存</span></span><br><span class="line">  abstractEventQueue = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 若 processingAbstractEventQueue 是数组则遍历执行 executeDispatchesAndRelease 函数</span></span><br><span class="line">  <span class="comment">// 反之 executeDispatchesAndRelease(processingAbstractEventQueue)</span></span><br><span class="line">  <span class="title function_">forEachAccumulated</span>(processingAbstractEventQueue, executeDispatchesAndRelease);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> executeDispatchesAndRelease = <span class="keyword">function</span>(<span class="params">abstractEvent</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (abstractEvent) &#123;</span><br><span class="line">    <span class="comment">// 获得对应的注册事件名称</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">PluginModule</span> = <span class="title function_">getPluginModuleForAbstractEvent</span>(abstractEvent);</span><br><span class="line">    <span class="comment">// 比如获得了 SimpleEventPlugin.executeDispatch ，用于实现与默认实现相同，但在返回值为 false 时取消事件除外的功能</span></span><br><span class="line">    <span class="keyword">var</span> pluginExecuteDispatch = <span class="title class_">PluginModule</span> &amp;&amp; <span class="title class_">PluginModule</span>.<span class="property">executeDispatch</span>;</span><br><span class="line">    <span class="title class_">EventPluginUtils</span>.<span class="title function_">executeDispatchesInOrder</span>(</span><br><span class="line">      abstractEvent,</span><br><span class="line">      pluginExecuteDispatch || <span class="title class_">EventPluginUtils</span>.<span class="property">executeDispatch</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 销毁抽象事件</span></span><br><span class="line">    <span class="title class_">AbstractEvent</span>.<span class="title function_">release</span>(abstractEvent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPluginModuleForAbstractEvent</span>(<span class="params">abstractEvent</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (abstractEvent.<span class="property">type</span>.<span class="property">registrationName</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> registrationNames[abstractEvent.<span class="property">type</span>.<span class="property">registrationName</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> phase <span class="keyword">in</span> abstractEvent.<span class="property">type</span>.<span class="property">phasedRegistrationNames</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!abstractEvent.<span class="property">type</span>.<span class="property">phasedRegistrationNames</span>.<span class="title function_">hasOwnProperty</span>(phase)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> <span class="title class_">PluginModule</span> = registrationNames[</span><br><span class="line">        abstractEvent.<span class="property">type</span>.<span class="property">phasedRegistrationNames</span>[phase]</span><br><span class="line">      ];</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">PluginModule</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">PluginModule</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实例化抽象事件"><a href="#实例化抽象事件" class="headerlink" title="实例化抽象事件"></a>实例化抽象事件</h3><p>这里将对 <code>SimpleEventPlugin.extractAbstractEvents</code> 或者是 <code>EnterLeaveEventPlugin.extractAbstractEvents</code> 进行解读。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eventPlugins/SimpleEventPlugin.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">SimpleEventPlugin</span> = &#123;</span><br><span class="line">  <span class="comment">// &#x27;topClick&#x27;, event, &#x27;.reactRoot[0]&#x27;, target</span></span><br><span class="line">  <span class="attr">extractAbstractEvents</span>: <span class="keyword">function</span>(<span class="params">topLevelType, nativeEvent, renderedTargetID, renderedTarget</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> data;</span><br><span class="line">    <span class="comment">// SimpleEventPlugin.abstractEventTypes 的映射</span></span><br><span class="line">    <span class="keyword">var</span> abstractEventType =</span><br><span class="line">      <span class="title class_">SimpleEventPlugin</span>.<span class="property">topLevelTypesToAbstract</span>[topLevelType];</span><br><span class="line">    <span class="keyword">if</span> (!abstractEventType) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span>(topLevelType) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 实例化 AbstractEvent</span></span><br><span class="line">    <span class="keyword">var</span> abstractEvent = <span class="title class_">AbstractEvent</span>.<span class="title function_">getPooled</span>(</span><br><span class="line">      abstractEventType,</span><br><span class="line">      renderedTargetID,</span><br><span class="line">      topLevelType,</span><br><span class="line">      nativeEvent,</span><br><span class="line">      data</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 这里是个关键</span></span><br><span class="line">    <span class="comment">// 对捕获和冒泡分别进行派发这个 AbstractEvent 实例</span></span><br><span class="line">    <span class="title class_">EventPropagators</span>.<span class="title function_">accumulateTwoPhaseDispatches</span>(abstractEvent);</span><br><span class="line">    <span class="keyword">return</span> abstractEvent;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">SimpleEventPlugin</span>.<span class="property">topLevelTypesToAbstract</span> = &#123;</span><br><span class="line">  <span class="attr">topMouseDown</span>:   <span class="title class_">SimpleEventPlugin</span>.<span class="property">abstractEventTypes</span>.<span class="property">mouseDown</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在 <code>EnterLeaveEventPlugin.js</code> 中， <code>extractAbstractEvents</code> 方法返回了 <code>[leave, enter]</code> 的 AbstractEvent 实例化，并且调用 <code>EventPropagators.accumulateEnterLeaveDispatches(leave, enter, fromID, toID);</code> 进行派发。</p>
<p><code>EventPropagators.js</code> 相关的方法稍后做解读。</p>
<p>那么在之前调用 <code>executeDispatchesAndRelease</code> 函数时，执行相应函数涉及到的函数如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event/EventPluginUtils.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">executeDispatch</span>(<span class="params">abstractEvent, listener, domID</span>) &#123;</span><br><span class="line">  <span class="comment">// forEachEventDispatch 函数中对应的 cb(abstractEvent, dispatchListeners, dispatchIDs)</span></span><br><span class="line">  <span class="title function_">listener</span>(abstractEvent, domID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">executeDispatchesInOrder</span>(<span class="params">abstractEvent, executeDispatch</span>) &#123;</span><br><span class="line">  <span class="title function_">forEachEventDispatch</span>(abstractEvent, executeDispatch);</span><br><span class="line">  abstractEvent.<span class="property">_dispatchListeners</span> = <span class="literal">null</span>;</span><br><span class="line">  abstractEvent.<span class="property">_dispatchIDs</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">forEachEventDispatch</span>(<span class="params">abstractEvent, cb</span>) &#123;</span><br><span class="line">  <span class="comment">// 在初始化的时候，这两个内容都是被置为 null 的</span></span><br><span class="line">  <span class="comment">// 他们都在 EventPropagators 被赋值</span></span><br><span class="line">  <span class="comment">// 若存在的情况下，这就是你在元素上定义的事件回调及对应的 ID</span></span><br><span class="line">  <span class="keyword">var</span> dispatchListeners = abstractEvent.<span class="property">_dispatchListeners</span>;</span><br><span class="line">  <span class="keyword">var</span> dispatchIDs = abstractEvent.<span class="property">_dispatchIDs</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(dispatchListeners)) &#123;</span><br><span class="line">    <span class="keyword">var</span> i;</span><br><span class="line">    <span class="keyword">for</span> (</span><br><span class="line">      i = <span class="number">0</span>;</span><br><span class="line">      i &lt; dispatchListeners.<span class="property">length</span> &amp;&amp; !abstractEvent.<span class="property">isPropagationStopped</span>;</span><br><span class="line">      i++) &#123;</span><br><span class="line">      <span class="comment">// Listeners and IDs are two parallel arrays that are always in sync.</span></span><br><span class="line">      <span class="title function_">cb</span>(abstractEvent, dispatchListeners[i], dispatchIDs[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dispatchListeners) &#123;</span><br><span class="line">    <span class="title function_">cb</span>(abstractEvent, dispatchListeners, dispatchIDs);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="抽象事件-AbstractEvent"><a href="#抽象事件-AbstractEvent" class="headerlink" title="抽象事件 AbstractEvent"></a>抽象事件 AbstractEvent</h3><p>大家对 <code>AbstractEvent</code> 的属性有些疑问，因为刚刚在提到的时候并没有提到 <code>AbstractEvent</code> 的实现。那么接下来解释下，这样能把全部都串联起来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event/AbstractEvent.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">MAX_POOL_SIZE</span> = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">AbstractEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">    abstractEventType,</span></span><br><span class="line"><span class="params">    abstractTargetID,  <span class="comment">// Allows the abstract target to differ from native.</span></span></span><br><span class="line"><span class="params">    originatingTopLevelEventType,</span></span><br><span class="line"><span class="params">    nativeEvent,</span></span><br><span class="line"><span class="params">    data</span>) &#123;</span><br><span class="line">  <span class="comment">// SimpleEventPlugin.abstractEventTypes.click, .reactRoot[0]&#x27;, &#x27;topClick&#x27;, event, data</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">type</span> = abstractEventType;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">abstractTargetID</span> = abstractTargetID || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">originatingTopLevelEventType</span> = originatingTopLevelEventType;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">nativeEvent</span> = nativeEvent;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">data</span> = data;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">target</span> = nativeEvent &amp;&amp; nativeEvent.<span class="property">target</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_dispatchListeners</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_dispatchIDs</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">isPropagationStopped</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">AbstractEvent</span>.<span class="property">poolSize</span> = <span class="variable constant_">MAX_POOL_SIZE</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">AbstractEvent</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">destructor</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">target</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_dispatchListeners</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_dispatchIDs</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">PooledClass</span>.<span class="title function_">addPoolingTo</span>(<span class="title class_">AbstractEvent</span>, <span class="title class_">PooledClass</span>.<span class="property">fiveArgumentPooler</span>);</span><br></pre></td></tr></table></figure>

<h3 id="模拟捕获-冒泡（1）"><a href="#模拟捕获-冒泡（1）" class="headerlink" title="模拟捕获&#x2F;冒泡（1）"></a>模拟捕获&#x2F;冒泡（1）</h3><p>现在我们来看到刚刚忽略掉的 <code>EventPropagators.accumulateTwoPhaseDispatches</code> 和 <code>EventPropagators.accumulateEnterLeaveDispatches</code> 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event/EventPropagators.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">accumulateTwoPhaseDispatches</span>(<span class="params">abstractEvents</span>) &#123;</span><br><span class="line">  <span class="title function_">forEachAccumulated</span>(abstractEvents, accumulateTwoPhaseDispatchesSingle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">accumulateTwoPhaseDispatchesSingle</span>(<span class="params">abstractEvent</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (abstractEvent &amp;&amp; abstractEvent.<span class="property">type</span>.<span class="property">phasedRegistrationNames</span>) &#123;</span><br><span class="line">    <span class="comment">// 获得 phasedRegistrationNames 对象</span></span><br><span class="line">    injection.<span class="property">InstanceHandle</span>.<span class="title function_">traverseTwoPhase</span>(</span><br><span class="line">      abstractEvent.<span class="property">abstractTargetID</span>,</span><br><span class="line">      accumulateDirectionalDispatches,</span><br><span class="line">      abstractEvent</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">accumulateEnterLeaveDispatches</span>(<span class="params">leave, enter, fromID, toID</span>) &#123;</span><br><span class="line">  injection.<span class="property">InstanceHandle</span>.<span class="title function_">traverseEnterLeave</span>(</span><br><span class="line">    fromID,</span><br><span class="line">    toID,</span><br><span class="line">    accumulateDispatches,</span><br><span class="line">    leave,</span><br><span class="line">    enter</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">listenerAtPhase</span>(<span class="params">id, abstractEvent, propagationPhase</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取对应的注册名称</span></span><br><span class="line">  <span class="keyword">var</span> registrationName =</span><br><span class="line">    abstractEvent.<span class="property">type</span>.<span class="property">phasedRegistrationNames</span>[propagationPhase];</span><br><span class="line">  <span class="comment">// 这个 getListener 函数需要看到 CallbackRegistry.js 相关的方法</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getListener</span>(id, registrationName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">accumulateDirectionalDispatches</span>(<span class="params">domID, upwards, abstractEvent</span>) &#123;</span><br><span class="line">  <span class="comment">// domID = 当前 traverseParentPath 的 ID</span></span><br><span class="line">  <span class="comment">// upwards = true / false</span></span><br><span class="line">  <span class="keyword">var</span> phase = upwards ? <span class="title class_">PropagationPhases</span>.<span class="property">bubbled</span> : <span class="title class_">PropagationPhases</span>.<span class="property">captured</span>;</span><br><span class="line">  <span class="comment">// 获得对应的 cb</span></span><br><span class="line">  <span class="keyword">var</span> listener = <span class="title function_">listenerAtPhase</span>(domID, abstractEvent, phase);</span><br><span class="line">  <span class="keyword">if</span> (listener) &#123;</span><br><span class="line">    <span class="comment">// 如果回调存在的情况下对 _dispatchListeners 和 _dispatchIDs 进行合并</span></span><br><span class="line">    <span class="comment">// 本身不存在的情况下，返回新的 listener 和 domID</span></span><br><span class="line">    <span class="comment">// 存在的情况下返回 listener[] 和 domID[]</span></span><br><span class="line">    abstractEvent.<span class="property">_dispatchListeners</span> =</span><br><span class="line">      <span class="title function_">accumulate</span>(abstractEvent.<span class="property">_dispatchListeners</span>, listener);</span><br><span class="line">    abstractEvent.<span class="property">_dispatchIDs</span> = <span class="title function_">accumulate</span>(abstractEvent.<span class="property">_dispatchIDs</span>, domID);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也是同样</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">accumulateDispatches</span>(<span class="params">id, ignoredDirection, abstractEvent</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (abstractEvent &amp;&amp; abstractEvent.<span class="property">type</span>.<span class="property">registrationName</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> listener = <span class="title function_">getListener</span>(id, abstractEvent.<span class="property">type</span>.<span class="property">registrationName</span>);</span><br><span class="line">    <span class="keyword">if</span> (listener) &#123;</span><br><span class="line">      abstractEvent.<span class="property">_dispatchListeners</span> =</span><br><span class="line">        <span class="title function_">accumulate</span>(abstractEvent.<span class="property">_dispatchListeners</span>, listener);</span><br><span class="line">      abstractEvent.<span class="property">_dispatchIDs</span> = <span class="title function_">accumulate</span>(abstractEvent.<span class="property">_dispatchIDs</span>, id);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="存储事件回调"><a href="#存储事件回调" class="headerlink" title="存储事件回调"></a>存储事件回调</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event/CallbackRegistry.js</span></span><br><span class="line"><span class="comment">// 回调监听银行，用于存储各种 cb</span></span><br><span class="line"><span class="keyword">var</span> listenerBank = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">CallbackRegistry</span> = &#123;</span><br><span class="line">  <span class="comment">// 加入 cb</span></span><br><span class="line">  <span class="attr">putListener</span>: <span class="keyword">function</span>(<span class="params">id, registrationName, listener</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> bankForRegistrationName =</span><br><span class="line">      listenerBank[registrationName] || (listenerBank[registrationName] = &#123;&#125;);</span><br><span class="line">    bankForRegistrationName[id] = listener;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 获得 cb</span></span><br><span class="line">  <span class="attr">getListener</span>: <span class="keyword">function</span>(<span class="params">id, registrationName</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> bankForRegistrationName = listenerBank[registrationName];</span><br><span class="line">    <span class="keyword">return</span> bankForRegistrationName &amp;&amp; bankForRegistrationName[id];</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 移除 cb</span></span><br><span class="line">  <span class="attr">deleteListener</span>: <span class="keyword">function</span>(<span class="params">id, registrationName</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> bankForRegistrationName = listenerBank[registrationName];</span><br><span class="line">    <span class="keyword">if</span> (bankForRegistrationName) &#123;</span><br><span class="line">      <span class="keyword">delete</span> bankForRegistrationName[id];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 清空所有</span></span><br><span class="line">  <span class="attr">__purge</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    listenerBank = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="模拟捕获-冒泡（2）"><a href="#模拟捕获-冒泡（2）" class="headerlink" title="模拟捕获&#x2F;冒泡（2）"></a>模拟捕获&#x2F;冒泡（2）</h3><p>这里所调用的 <code>injection.InstanceHandle</code> 下的方法其实就是 <code>ReactInstanceHandles</code> 的方法，回忆到在默认注入的时候，那么这里来看下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/ReactInstanceHandles.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">ReactInstanceHandles</span> = &#123;</span><br><span class="line">  <span class="attr">traverseTwoPhase</span>: <span class="keyword">function</span>(<span class="params">targetID, cb, arg</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (targetID) &#123;</span><br><span class="line">      <span class="comment">// 直接看到 traverseParentPath 函数</span></span><br><span class="line">      <span class="comment">// 比如:</span></span><br><span class="line">      <span class="comment">// .reactRoot[0].[3].0</span></span><br><span class="line">      <span class="comment">// 捕获阶段： .reactRoot[0] =&gt; .reactRoot[0].[3] =&gt; .reactRoot[0].[3].0</span></span><br><span class="line">      <span class="comment">// 冒泡阶段： .reactRoot[0].[3].0 =&gt; .reactRoot[0].[3] =&gt; .reactRoot[0]</span></span><br><span class="line">      <span class="comment">// 他里面是通过前后 &#x27;.&#x27; 来控制判断的</span></span><br><span class="line">      <span class="comment">// 具体就是那行 for 循环代码以及相关的操作函数</span></span><br><span class="line">      <span class="title function_">traverseParentPath</span>(<span class="string">&#x27;&#x27;</span>, targetID, cb, arg, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">      <span class="title function_">traverseParentPath</span>(targetID, <span class="string">&#x27;&#x27;</span>, cb, arg, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">traverseEnterLeave</span>: <span class="keyword">function</span>(<span class="params">leaveID, enterID, cb, upArg, downArg</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取两个ID最近的共同祖先ID</span></span><br><span class="line">    <span class="keyword">var</span> longestCommonID = <span class="title class_">ReactInstanceHandles</span>.<span class="title function_">getFirstCommonAncestorID</span>(</span><br><span class="line">      leaveID,</span><br><span class="line">      enterID</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (longestCommonID !== leaveID) &#123;</span><br><span class="line">      <span class="title function_">traverseParentPath</span>(leaveID, longestCommonID, cb, upArg, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (longestCommonID !== enterID) &#123;</span><br><span class="line">      <span class="title function_">traverseParentPath</span>(longestCommonID, enterID, cb, downArg, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在两个ID之间遍历父路径（向上或向下）。ID不能相同，并且它们之间必须存在父路径。</span></span><br><span class="line"><span class="comment">// 方法的作用因为比较抽象，我会举个例子在上面。</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traverseParentPath</span>(<span class="params">start, stop, cb, arg, skipFirst, skipLast</span>) &#123;</span><br><span class="line">  start = start || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  stop = stop || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="title function_">invariant</span>(</span><br><span class="line">    start !== stop,</span><br><span class="line">    <span class="string">&#x27;traverseParentPath(...): Cannot traverse from and to the same ID, `%s`.&#x27;</span>,</span><br><span class="line">    start</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">var</span> ancestorID = <span class="title class_">ReactInstanceHandles</span>.<span class="title function_">getFirstCommonAncestorID</span>(start, stop);</span><br><span class="line">  <span class="keyword">var</span> traverseUp = ancestorID === stop;</span><br><span class="line">  <span class="title function_">invariant</span>(</span><br><span class="line">    traverseUp || ancestorID === start,</span><br><span class="line">    <span class="string">&#x27;traverseParentPath(%s, %s, ...): Cannot traverse from two IDs that do &#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;not have a parent path.&#x27;</span>,</span><br><span class="line">    start,</span><br><span class="line">    stop</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// Traverse from `start` to `stop` one depth at a time.</span></span><br><span class="line">  <span class="keyword">var</span> depth = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 通过 traverseUp 来控制是使用 parentID 函数还是 nextDescendantID 方法。</span></span><br><span class="line">  <span class="comment">// 就是从前往后取或者是从后往前取</span></span><br><span class="line">  <span class="keyword">var</span> traverse = traverseUp ? parentID : <span class="title class_">ReactInstanceHandles</span>.<span class="property">nextDescendantID</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> id = start; <span class="comment">/* until break */</span>; id = <span class="title function_">traverse</span>(id, stop)) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((!skipFirst || id !== start) &amp;&amp; (!skipLast || id !== stop)) &#123;</span><br><span class="line">      <span class="title function_">cb</span>(id, traverseUp, arg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (id === stop) &#123;</span><br><span class="line">      <span class="comment">// Only break //after// visiting `stop`.</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">invariant</span>(</span><br><span class="line">      depth++ &lt; <span class="variable constant_">MAX_TREE_DEPTH</span>,</span><br><span class="line">      <span class="string">&#x27;traverseParentPath(%s, %s, ...): Detected an infinite loop while &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;traversing the React DOM ID tree. This may be due to malformed IDs: %s&#x27;</span>,</span><br><span class="line">      start, stop</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后呢就是在 <code>ReactNativeComponent.js</code> 中 <code>_createOpenTagMarkup</code> 方法中的 <code>putListener</code> 函数，看过 <code>putListener</code> 函数就是用于存入回调函数的，在 <code>getListener</code> 获得则会去执行。</p>
<p>那么到此为止，实现事件机制。</p>

                </div>
            </div>

            
            <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者: </strong>
    Zong
  </li>
  <li class="post-copyright-link">
    <strong>本文链接: </strong>
    <a href="https://zongzi531.com/2019/04/05/LSC-React-05/" title="React 源码学习（五）：事件机制">https://zongzi531.com/2019/04/05/LSC-React-05/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明: </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

            
    
            <nav class="post-pagination">
    
    <a class="newer-posts" href="/2019/04/06/LSC-React-06/">
        上一篇<br>React 源码学习（六）：组件渲染
    </a>
    
    <span class="page-number"></span>
    
    <a class="older-posts" href="/2019/04/04/LSC-React-04/">
        下一篇<br>React 源码学习（四）：事务机制
    </a>
    
</nav>

    
            

<div class="post-comment-wrapper">
    <div class="giscus"></div>
</div>


        </div>
    </div>
    <div class="single-column-footer">
    <div style="margin-bottom: 8px;">
        <a title="GitHub" target="_blank" rel="noopener" href="https://github.com/zongzi531" style="margin: 0px 2px;"><svg height="16" width="16" viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a>
        <a title="知乎" target="_blank" rel="noopener" href="https://www.zhihu.com/people/zongzi531/posts" style="margin: 0px 2px;"><img height="16" src="https://static.zhihu.com/static/favicon.ico"></a>
        <a title="掘金" target="_blank" rel="noopener" href="https://juejin.im/user/58747cf2ac502e00646e3b8b/posts" style="margin: 0px 2px;"><img height="16" src="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/favicons/favicon-32x32.png"></a>
        <a title="力扣" target="_blank" rel="noopener" href="https://leetcode-cn.com/u/zongzi0531/" style="margin: 0px 2px;"><img height="16" src="https://static.leetcode-cn.com/cn-assets/icons/favicon-32x32.png"></a>
    </div>
    &copy; 2017 - 2023 <a href="https://zongzi531.com">Zong</a>
</div>
</div>

</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"
        integrity="sha256-EGs9T1xMHdvM1geM8jPpoo8EZ1V1VRsmcJz8OByENLA=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"
        integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"
        integrity="sha256-FtWfRI+thWlNz2sB3SJbwKx5PgMyKIVgwHCTwa3biXc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@14.2.1/dist/smooth-scroll.polyfills.min.js"
        integrity="sha256-CI4Gq5E0io1Pv0xM3qPM+NUIOhbIBvC3GiN1Y4KhXpw=" crossorigin="anonymous"></script>
<script src="/js/journal.js?42215962"></script>


    <script src="https://giscus.app/client.js"
    data-repo="zongzi531/zongzi531.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkyMTgyODY2MjA="
    data-category="General"
    data-category-id="DIC_kwDODQLKHM4COlHH"
    data-mapping="url"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
</script>


</body>
</html>
