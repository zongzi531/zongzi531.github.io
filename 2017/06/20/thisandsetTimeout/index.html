









<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            <div class="post-head-wrapper"
                 style="background-image: url('/2017/06/20/thisandsetTimeout/pic.jpeg')">
                <div class="post-title">
                    this &amp; setTimeout
                    <div class="post-meta">
                        <time datetime="2017-06-20T22:05:55.000Z" itemprop="datePublished">
                            2017-06-20 22:05
                        </time>&nbsp;
                        
                        
                        <i class="material-icons" style="">folder</i>
                        
                        <a href='/categories/JavaScript/'>JavaScript</a>
                        
                        
    
                        
                        
                        <i class="material-icons" style="">label</i>
                        
                        <a href='/tags/JavaScript/'>JavaScript</a>
                        
                        
                    </div>
                </div>
            </div>
    
            <div class="post-body-wrapper">
                <div class="post-body">
                    <!-- no node -->

<span id="more"></span>

<p>首先关于上一篇博客<a href="http://zongzi531.com/2017/06/17/vue%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/">《Vue实战经验分享》</a>最后提到的问题进行解答，<code>exampleData</code>的结果是：<code>&#39;example 1&#39;</code>。</p>
<p>OK，那是什么样的业务场景会让我遇到这样的问题呢，当时我想将一段代码延迟执行，但是一开始我直接使用this，导致这句话并没有延迟执行。</p>
<p>那么之后我看到了这么一段很有趣的话：</p>
<blockquote>
<p>inside function called by setTimeout this is NOT VueJs object (is setTimeout global object), but self, also called after 2 seconds, is still VueJs Object.</p>
</blockquote>
<p>也就是说，在<code>setTimeout</code>方法中的<code>this</code>指向的是一个全局对象，而非Vue对象。简而言之就是此<code>this</code>非彼<code>this</code>。</p>
<p>好，那么我们来认真认识一下他们吧！</p>
<hr>
<h2 id="关于this"><a href="#关于this" class="headerlink" title="关于this"></a>关于this</h2><p>在绝大多数情况下，函数的调用方式决定了<code>this</code>的值。<code>this</code>不能在执行期间被赋值，在每次函数被调用时<code>this</code>的值也可能会不同。</p>
<h3 id="this在全局上下文"><a href="#this在全局上下文" class="headerlink" title="this在全局上下文"></a>this在全局上下文</h3><p>在全局运行上下文中（在任何函数体外部），<code>this</code>指代全局对象，无论是否在严格模式下。</p>
<p>比如在浏览器中指<code>window</code>，Node中指<code>global</code>。</p>
<p>以下例子运行在浏览器中：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>document <span class="token operator">===</span> document<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>

<span class="token comment" spellcheck="true">// 在浏览器中，全局对象为 window 对象：</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">37</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 37</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="this在函数上下文"><a href="#this在函数上下文" class="headerlink" title="this在函数上下文"></a>this在函数上下文</h3><p>在函数内部，<code>this</code>的值取决于函数是如何调用的。</p>
<p>在非严格模式下执行，此时的<code>this</code>的值会默认设置为全局对象。然而，在严格模式下，<code>this</code>将保持他进入执行环境时的值，所以下面的<code>this</code>将会默认为<code>undefined</code>，如果<code>this</code>未被执行的上下文环境定义，那么它将会默认为<code>undefined</code>。</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> window<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>

<span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token string">"use strict"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 这里是严格模式</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> undefined<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="关于setTimeout"><a href="#关于setTimeout" class="headerlink" title="关于setTimeout"></a>关于setTimeout</h2><blockquote>
<p>这里只提到关于<code>this</code>的问题</p>
</blockquote>
<p>当你向 <code>setTimeout()</code> (或者其他函数也行)传递一个函数时，该函数中的<code>this</code>会指向一个错误的值。这个问题在 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this#As_an_object_method">JavaScript reference</a> 中进行了详细解释。</p>
<h3 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h3><p>由<code>setTimeout()</code>调用的代码运行在与所在函数完全分离的执行环境上。这会导致，这些代码中包含的 <code>this</code> 关键字会指向 <code>window</code> (或全局)对象，这和所期望的<code>this</code>的值是不一样的。查看下面的例子：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">myArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"zero"</span><span class="token punctuation">,</span> <span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
myArray<span class="token punctuation">.</span>myMethod <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>sProperty<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">[</span>sProperty<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

myArray<span class="token punctuation">.</span><span class="token function">myMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// prints "zero,one,two"</span>
myArray<span class="token punctuation">.</span><span class="token function">myMethod</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// prints "one"</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>myArray<span class="token punctuation">.</span>myMethod<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// prints "[object Window]" after 1 second</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>myArray<span class="token punctuation">.</span>myMethod<span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// prints "undefined" after 1,5 seconds</span>
<span class="token comment" spellcheck="true">// let's try to pass the 'this' object</span>
setTimeout<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>myArray<span class="token punctuation">,</span> myArray<span class="token punctuation">.</span>myMethod<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// error: "NS_ERROR_XPC_BAD_OP_ON_WN_PROTO: Illegal operation on WrappedNative prototype object"</span>
setTimeout<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>myArray<span class="token punctuation">,</span> myArray<span class="token punctuation">.</span>myMethod<span class="token punctuation">,</span> <span class="token number">2500</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// same error</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>正如你所看到的一样，我们没有任何方法将<code>this</code>对象传递给回调函数。</p>
<p>一个可用的解决 “this” 问题的方法是使用两个非原生的<code>setTimeout()</code> 和 <code>setInterval()</code> 全局函数代替原生的。该非原生的函数通过使用<code>Function.prototype.call</code> 方法激活了正确的作用域。下面的代码显示了应该如何替换：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// Enable the passage of the 'this' object through the JavaScript timers</span>
 
<span class="token keyword">var</span> __nativeST__ <span class="token operator">=</span> window<span class="token punctuation">.</span>setTimeout<span class="token punctuation">,</span> __nativeSI__ <span class="token operator">=</span> window<span class="token punctuation">.</span>setInterval<span class="token punctuation">;</span>
 
window<span class="token punctuation">.</span>setTimeout <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>vCallback<span class="token punctuation">,</span> nDelay <span class="token comment" spellcheck="true">/*, argumentToPass1, argumentToPass2, etc. */</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> oThis <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> aArgs <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__nativeST__</span><span class="token punctuation">(</span>vCallback <span class="token keyword">instanceof</span> <span class="token class-name">Function</span> <span class="token operator">?</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    vCallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>oThis<span class="token punctuation">,</span> aArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token punctuation">:</span> vCallback<span class="token punctuation">,</span> nDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 
window<span class="token punctuation">.</span>setInterval <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>vCallback<span class="token punctuation">,</span> nDelay <span class="token comment" spellcheck="true">/*, argumentToPass1, argumentToPass2, etc. */</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> oThis <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> aArgs <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__nativeSI__</span><span class="token punctuation">(</span>vCallback <span class="token keyword">instanceof</span> <span class="token class-name">Function</span> <span class="token operator">?</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    vCallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>oThis<span class="token punctuation">,</span> aArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token punctuation">:</span> vCallback<span class="token punctuation">,</span> nDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>注：JavaScript 1.8.5 引入了 <code>Function.prototype.bind()</code> 方法，该方法允许显式地指定函数调用时 <code>this</code> 所指向的值 。该方法可以帮助你解决 <code>this</code> 指向不确定的问题。</p>
</blockquote>
<p>上面这段代码中最重点的一句话就是<code>var oThis = this</code>。</p>
<p>其实说了这么多，也很容易把这个问题延伸出去，那就可以聊一聊：<strong>JavaScript上下文与作用域</strong>。</p>
<p>我只能说目前我学习到的内容还是很浅的，还做不到很好的总结。</p>
<p>待我再揣摩揣摩吧~</p>
<h2 id="参考与学习"><a href="#参考与学习" class="headerlink" title="参考与学习"></a>参考与学习</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/38399050/vue-equivalent-of-settimeout">Vue equivalent of setTimeOut? - Stack Overflow</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this">this - JavaScript | MDN</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout">window.setTimeout - API | MDN</a></li>
</ul>

                </div>
            </div>

            
            
            
    
            
    
            
        </div>
    </div>
    
</div>






