









<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            <div class="post-head-wrapper"
                 style="background-image: url('/2020/02/27/对 Redux 的代码分割/pic.png')">
                <div class="post-title">
                    对 Redux 的代码分割
                    <div class="post-meta">
                        <time datetime="2020-02-27T14:22:21.000Z" itemprop="datePublished">
                            2020-02-27 14:22
                        </time>&nbsp;
                        
                        
                        <i class="material-icons" style="">folder</i>
                        
                        <a href='/categories/React/'>React</a>
                        
                        
    
                        
                        
                        <i class="material-icons" style="">label</i>
                        
                        <a href='/tags/Redux/'>Redux</a>, 
                        
                        <a href='/tags/Code-Splitting/'>Code Splitting</a>, 
                        
                        <a href='/tags/代码分割/'>代码分割</a>
                        
                        
                    </div>
                </div>
            </div>
    
            <div class="post-body-wrapper">
                <div class="post-body">
                    <!-- no node -->

<span id="more"></span>

<p>相信大家都知道利用 React 脚手架 Create React App 构建出来的 React 项目是基于 Webpack 构建的。那么官方也提供了关于拆分 React 代码，实现代码分割的功能。</p>
<p>那么需要使用到的就是 <code>import()</code> 也就是 dynamic import 动态导入功能，配合 <code>React.lazy</code> 进行使用，即可实现代码分割。</p>
<p>关于这一块部分如果你还没有很好的了解，建议你可以看一下<a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/code-splitting.html#code-splitting">《代码分割 - React》</a>。</p>
<p>在我司项目的快迭代环境下，我也选择这套方案来进行优化，但是我在后续的开发过程中发现，这套解决方案并不完善，因为对于 Redux ，我并没有做到代码分割，当迭代过程中仅涉及到修改 Redux reducer 时会出现大批量代码更新。</p>
<p>因为项目中仅使用了一个 <code>store</code> 来使用 Redux ，当里面出现一个细小的变化会导致整个 <code>store</code> 的打包 <code>hash</code> 值变化，从而影响到大部分被分割的 React 代码，包括很多并未做修改的文件。</p>
<p>所以我开始着手对 Redux 进行代码分割，官方<a target="_blank" rel="noopener" href="https://redux.js.org/recipes/code-splitting/">《Code Splitting - Redux》</a>也提供了很好的支持。</p>
<p>基于此，我开始修改项目中的代码， 依照官方的例子开始修改：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/**
 * rootReducer 即认为静态 reducer
 * asyncReducers 即认为需要合并的异步 reducer
 */</span>
<span class="token keyword">const</span> createReducer <span class="token operator">=</span> asyncReducers <span class="token operator">=</span><span class="token operator">></span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>rootReducer<span class="token punctuation">,</span>
  <span class="token operator">...</span>asyncReducers
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 暴露给外界的注入函数</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> injectReducer<span class="token punctuation">;</span>

<span class="token keyword">const</span> configureStore <span class="token operator">=</span> preloadedState <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>
    <span class="token function">combineReducers</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">)</span><span class="token punctuation">,</span>
    preloadedState<span class="token punctuation">,</span>
    middleware
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  store<span class="token punctuation">.</span>asyncReducers <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 注入函数</span>
  injectReducer <span class="token operator">=</span> store<span class="token punctuation">.</span>injectReducer <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> asyncReducer<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>asyncReducers<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">// 赋值</span>
    store<span class="token punctuation">.</span>asyncReducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> asyncReducer<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 合并 reducer 并调用 replaceReducer 方法更新</span>
    store<span class="token punctuation">.</span><span class="token function">replaceReducer</span><span class="token punctuation">(</span><span class="token function">createReducer</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>asyncReducers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> store<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> configureStore<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对原先的创建 <code>store</code> 过程进行了更新，暴露了 <code>injectReducer</code> 函数用于异步注入，结合 <code>import()</code> 就可以实现对 React 的代码分割，真是非常喜悦。</p>
<p>那我们来看看怎么用：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> lazy <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> injectReducer <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">from</span> <span class="token string">'@/store/configureStore'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  Something<span class="token punctuation">:</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* webpackChunkName: 'Something' */</span><span class="token string">'@/reducers/something'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token function">injectReducer</span><span class="token punctuation">(</span><span class="token string">'something'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* webpackChunkName: 'Something' */</span><span class="token string">'@/containers/Something'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用方法也特别简单，即动态导入后注入 reducer 即可，以实现代码分割。</p>
<p>那么到此，相对实现了一个比较完善的 React + Redux 的代码分割解决方案，可以以页面维度，或者你想要的细度去控制代码分割的程度以应对项目的快迭代。</p>

                </div>
            </div>

            
            
            
    
            
    
            
        </div>
    </div>
    
</div>






